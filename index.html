<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>SUPERVISI√ìN</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="icon" href="https://res.cloudinary.com/dqqeavica/image/upload/v1763928947/Logo_lt365u.png">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
  :root{
    --primary:#06402B;
    --primary-2:#04281C;
    --ok:#16a34a;
    --error:#dc2626;
    --scrim:rgba(0,0,0,.55);
  }
  html,body{
    margin:0; padding:0; height:100%; width:100%;
    overflow-x:hidden;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    color:#111;
    background: url('https://res.cloudinary.com/dqqeavica/image/upload/v1746905870/fondo_verde_tvntsi.png') center/cover fixed no-repeat;
  }
  .container{ max-width: 1100px; margin: 0 auto; padding: 16px; }

  .view{ display:none; opacity:0; transform: translateY(8px);
    transition: opacity .25s ease, transform .25s ease;
    box-sizing:border-box; padding:16px;
  }
  .view.active{ display:block; opacity:1; transform: translateY(0); }

  .card{
    background: rgba(255,255,255,.08);
    backdrop-filter: blur(4px);
    border: 2px solid #ddd;
    border-radius: 18px;
    box-shadow: 0 8px 22px rgba(0,0,0,.20);
    max-width: 820px;
    margin: 16px auto;
    padding: 22px 22px 18px;
  }
  h1,h2,h3{ margin: 8px 0 12px; text-align:center; }
  p.helper{ color:#222; font-size:.95rem; text-align:center; margin:8px 0 16px; font-weight:600; }
  label{ display:block; font-weight:700; margin: 10px 0 6px; color:var(--primary); }
  input, select, textarea, button{
    width:100%; padding:12px; box-sizing:border-box;
    border:1.5px solid #ccc; border-radius:12px; background:#fff;
    outline:none; transition: border-color .2s ease, transform .08s ease;
    font-size:16px;
  }
  input:focus, select:focus, textarea:focus{ border-color:var(--primary); }
  button{
    cursor:pointer; border:2px solid var(--primary);
    background:#fff; color:#000; font-weight:800; border-radius:12px;
  }
  button:hover{ background:var(--primary-2); color:#fff; border-color:var(--primary-2); }
  .btn-primary{ background:var(--primary); color:#fff; }
  .btn-row{ display:flex; gap:12px; flex-wrap:wrap; }
  .btn-row > *{ flex:1; }
  .muted{ color:#666; font-size:.8rem; }
  .center{ text-align:center; }
  .image-center{ display:flex; justify-content:center; }
  .brand{ width:240px; border-radius:12px; display:block; margin:12px auto 4px; }
  .banner-bottom{ width:240px; border-radius:12px; display:block; margin:16px auto 8px; }
  .chip{
    padding:10px 16px; border-radius:999px; border:2px solid var(--primary);
    background:#fff; font-weight:800; color:#000; text-decoration:none;
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
    box-shadow:0 4px 12px rgba(0,0,0,.12);
  }
  .danger{ background:#dc2626; border-color:#dc2626; color:#fff; }
  .danger:hover{ background:#991b1b; border-color:#991b1b; }

  /* Toggle c√©dula */
  .pwd-wrapper{ position:relative; width:100%; }
  .pwd-wrapper input#login-cedula{
    display:block; width:100%; box-sizing:border-box; padding-right:44px;
  }
  .toggle-cedula{
    position:absolute; top:50%; right:10px;
    transform:translateY(-50%);
    background:transparent !important; border:0; padding:0;
    width:32px; height:32px; display:flex; align-items:center; justify-content:center;
    cursor:pointer; border-radius:8px;
  }
  .toggle-cedula:hover{ background:rgba(0,0,0,.06); }
  .toggle-cedula img{ width:24px; height:24px; display:block; pointer-events:none; }

  /* Avatar / Firma */
  .avatar{
    width:132px; height:132px; border-radius:999px;
    border:3px solid #fff; box-shadow:0 6px 18px rgba(0,0,0,.25);
    object-fit:cover; background:#eee;
  }
  .firma-preview{
    width:100%; max-width:560px; border-radius:18px; border:2px solid #ddd;
    display:block; margin:12px auto 14px; background:#fff; padding:12px;
  }

  .view-title-name{
    font-size:1.35rem; font-weight:900; color:var(--primary); margin:4px 0 2px;
  }
  .view-title-role{
    font-size:.85rem; font-weight:800; color:#444; letter-spacing:.5px; margin:0 0 12px;
  }

  .list-grid{ display:flex; flex-direction:column; gap:14px; margin-top:14px; }
  .item-card{
    background: rgba(255,255,255,.08);
    backdrop-filter: blur(4px);
    border: 2px solid #ddd;
    border-radius:16px; padding:16px;
    box-shadow:0 6px 18px rgba(0,0,0,.18);
    display:flex; flex-direction:column; gap:6px;
  }
  .item-header{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:space-between; }
  .item-title{ font-weight:900; font-size:1rem; color:var(--primary); margin:0; }
  .item-sub{ font-size:.72rem; font-weight:700; color:#222; margin:0; letter-spacing:.3px; }

  /* Secciones expandibles revisi√≥n */
  .section-toggle{ margin:12px 0; }
  .section-content{
    margin:8px 0 18px;
    background: rgba(255,255,255,.08);
    backdrop-filter: blur(4px);
    border:2px solid #ddd;
    border-radius:16px;
    padding:14px;
    box-shadow:0 6px 18px rgba(0,0,0,.16);
  }
  .section-content.hidden{ display:none; }

  .oblig-block{
    background:#f9f9f9;
    border:1.5px solid #ccc;
    border-radius:14px;
    padding:10px 12px;
    margin:10px 0;
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  .oblig-title{ font-weight:800; margin:0; color:var(--primary); font-size:.9rem; }
  .oblig-sub{ margin:0; font-size:.75rem; color:#333; font-weight:600; }

  .evidence-grid{
    display:flex; flex-wrap:wrap; gap:10px;
    justify-content:center;
  }
  .evidence-thumb{
    width:100%; max-width:320px;
    aspect-ratio:4/3; object-fit:cover; border-radius:12px;
    border:2px solid #ddd; background:#eee; cursor:zoom-in;
    display:block; margin:0 auto;
  }

  /* Overlay men√∫ */
  .overlay{ position:fixed; inset:0; pointer-events:none; }
  .overlay.open{ pointer-events:auto; }
  .overlay .scrim{
    position:absolute; inset:0; background:var(--scrim);
    opacity:0; transition:opacity .25s ease;
  }
  .overlay.open .scrim{ opacity:1; }
  .overlay .panel{
    position:absolute; top:0; left:0; width:min(360px, 90vw); height:100%;
    background:var(--primary); color:#fff;
    padding:18px 18px 10px 18px; box-sizing:border-box;
    transform:translateX(-100%); transition: transform .25s ease;
    display:flex; flex-direction:column; gap:12px; overflow-y:auto;
  }
  .overlay.open .panel{ transform:translateX(0); }

  .menu-btn{
    background:#fff; color:#000; border:0;
    font-weight:800; border-radius:999px;
    padding:14px 16px; box-shadow:0 6px 16px rgba(0,0,0,.25);
    display:block; width:100%; cursor:pointer;
    letter-spacing:.3px;
  }
  .menu-btn:hover{ background:#06402B; color:#fff; }

  .btn-icon{
    background:transparent !important;
    border:0 !important; box-shadow:none !important;
    padding:8px !important; display:inline-flex; align-items:center; justify-content:center;
    cursor:pointer;
  }
  .btn-icon img{ width:46px; height:46px; object-fit:contain; display:block; pointer-events:none; }

  @media (max-width:700px){
    .btn-row{ flex-direction:column; }
  }
  </style>
</head>
<body>
  <!-- Loader -->
  <div id="loader" class="loader hidden" aria-live="polite" aria-busy="true">
    <div class="spinner-ios" role="status" aria-label="Cargando">
      <i></i><i></i><i></i><i></i><i></i><i></i>
      <i></i><i></i><i></i><i></i><i></i><i></i>
    </div>
  </div>

  <div class="container">

    <!-- VISTA INSTALAR -->
    <section id="view-instalar" class="view">
      <div class="card narrow" style="text-align:center;">
        <h2 style="color:var(--primary);">APP SUPERVISI√ìN</h2>
        <img class="brand" alt="Instalar" src="https://res.cloudinary.com/dqqeavica/image/upload/v1763930524/menu_t9xli7.gif" />
        <p style="font-weight:600;">Herramienta de uso exclusivo para Supervisoras y Supervisores de la Alcald√≠a de Flandes</p>
        <div class="btn-row" style="justify-content:center; margin-top:12px;">
          <button id="btn-instalar" class="btn-primary" style="display:none;">Instalar la App üì≤</button>
        </div>
        <p class="muted" style="margin-top:14px;">Si ya instalaste la App y no se inicia autom√°ticamente, refresca en unos segundos.</p>
      </div>
    </section>

    <!-- VISTA LOGIN -->
    <section id="view-login" class="view">
      <div class="card narrow">
        <h1 style="color:var(--primary); text-shadow:0 2px 2px #031732;">SUPERVISI√ìN</h1>
        <p class="helper"><b>Solo Supervisores autorizados pueden usar esta App.</b></p>

        <label>C√©dula</label>
        <div class="pwd-wrapper">
          <input
            id="login-cedula"
            type="password"
            inputmode="numeric"
            autocomplete="off"
            placeholder="Sin puntos ni espacios"
          />
          <button
            type="button"
            id="toggle-cedula"
            aria-label="Mostrar c√©dula"
            class="toggle-cedula"
          >
            <img src="https://res.cloudinary.com/dqqeavica/image/upload/v1764084782/Mostrar_yymceh.png" alt="Mostrar">
          </button>
        </div>

        <div class="btn-row" style="margin-top:18px;">
          <button class="btn-primary" id="btn-login">Iniciar Sesi√≥n</button>
        </div>

        <img class="brand" style="margin-top:22px;" alt="Banner" src="https://res.cloudinary.com/dqqeavica/image/upload/v1764758798/ALCALDIA_FLANDES_DIGITAL_x1kxxo.png" />
        <p class="center muted">Copyright ¬© <b>GOBIERNO DIGITAL</b></p>
      </div>
    </section>

    <!-- VISTA COMPLETAR / ACTUALIZAR REGISTRO -->
    <section id="view-completar" class="view">
      <div class="card narrow">
        <h2 style="color:var(--primary)">COMPLETA TU REGISTRO</h2>
        <p class="helper"><b>Sube tu Firma (requerida) y tu Imagen de Perfil (opcional).</b></p>

        <label>Tu Firma (requerida)</label>
        <input type="file" id="reg-firma" accept="image/*" />
        <img id="reg-firma-preview" src="" alt="Firma (vista previa)" style="display:none; max-width:100%; border-radius:14px; border:2px solid #d8e4ff; margin-top:8px;" />

        <label>Foto de Perfil (opcional)</label>
        <input type="file" id="reg-foto" accept="image/*" />
        <img id="reg-preview" src="" alt="Vista previa" style="display:none; max-width:100%; border-radius:14px; border:2px solid #d8e4ff; margin-top:8px;" />

        <div class="btn-row spaced" style="margin-top:18px;">
          <button id="btn-guardar-reg" class="btn-primary">Guardar</button>
          <button id="btn-cancelar-reg" class="danger">Cancelar</button>
        </div>
      </div>
    </section>

    <!-- VISTA INICIO -->
    <section id="view-inicio" class="view">
      <div class="card">
        <div class="btn-row" style="margin-bottom:12px;">
          <button class="danger" id="btn-logout">Cerrar Sesi√≥n</button>
          <button class="chip" id="btn-open-menu">Men√∫</button>
        </div>

        <div class="image-center">
          <img id="inicio-avatar" class="avatar" alt="avatar">
        </div>
        <p id="inicio-nombre" class="view-title-name"></p>
        <p id="inicio-rol" class="view-title-role">SUPERVISOR(A)</p>

        <img id="inicio-firma" class="firma-preview hidden" alt="Firma supervisi√≥n">

        <!-- NOTA: Sin botones directos (se usan desde Men√∫). -->
        <img class="brand" alt="Banner" src="https://res.cloudinary.com/dqqeavica/image/upload/v1764758798/ALCALDIA_FLANDES_DIGITAL_x1kxxo.png" />
        <p class="center muted">Copyright ¬© <b>GOBIERNO DIGITAL</b></p>
      </div>
    </section>

    <!-- VISTA CONTRATISTAS -->
    <section id="view-contratistas" class="view">
      <div class="card">
        <h2 style="color:var(--primary)">CONTRATISTAS</h2>

        <div class="center">
          <div id="contr-count" class="chip">0</div>
          <p id="contr-caption" class="muted" style="margin:6px 0 12px;">N¬∞ de Contratistas asignados</p>
        </div>

        <input id="contr-filter" class="filter-input" type="text" placeholder="Filtrar por nombre, documento, secretar√≠a o tel√©fono" aria-label="Filtrar contratistas">

        <div class="btn-row spaced">
          <button id="contr-volver" class="danger">REGRESAR</button>
        </div>

        <div id="contr-list" class="list-grid"></div>
      </div>
    </section>

    <!-- VISTA REVISI√ìN DE CUENTAS (LISTA) -->
    <section id="view-revision" class="view">
      <div class="card">
        <h2 style="color:var(--primary)">REVISAR CUENTAS</h2>

        <div class="center">
          <div id="cuentas-count" class="chip">0</div>
          <p class="muted" style="margin:6px 0 12px;">Cuentas con estado INGRESADA</p>
        </div>

        <input id="cuentas-filter" class="filter-input" type="text" placeholder="Filtrar por nombre, documento o informe">

        <div class="btn-row spaced">
          <button id="revision-volver" class="danger">REGRESAR</button>
        </div>

        <div id="cuentas-list" class="list-grid"></div>
      </div>
    </section>

    <!-- VISTA REVISAR CUENTA (DETALLE COMPLETO COMO index.md) -->
    <section id="view-revisar-cuenta" class="view">
      <div class="card">
        <h2 id="rc-title" style="color:var(--primary)">REVISI√ìN DE CUENTA</h2>
        <div id="rc-body" class="narrow"></div>

        <div class="section-toggle">
          <button id="btn-toggle-contrato" class="chip">Ver Informaci√≥n del Contrato</button>
        </div>
        <div id="sec-contrato" class="section-content hidden"></div>

        <div class="section-toggle">
          <button id="btn-toggle-informe" class="chip">Ver Relaci√≥n de Informe y Pago</button>
        </div>
        <div id="sec-informe" class="section-content hidden"></div>

        <div class="section-toggle">
          <button id="btn-toggle-planilla" class="chip">Ver Relaci√≥n de Planilla</button>
        </div>
        <div id="sec-planilla" class="section-content hidden"></div>

        <div class="section-toggle">
          <button id="btn-toggle-planilla2" class="chip">Ver Relaci√≥n de Planilla Anexa</button>
        </div>
        <div id="sec-planilla2" class="section-content hidden"></div>

        <div class="section-toggle">
          <button id="btn-toggle-actividades" class="chip">Ver Relaci√≥n de Actividades</button>
        </div>

        <!-- Bot√≥n abrir carpeta de cuenta -->
        <div class="center" style="margin-top:6px;">
          <button id="btn-abrir-carpeta-cuenta" class="btn-icon hidden" aria-label="Abrir carpeta de CUENTA en Drive" title="Abrir carpeta de CUENTA">
            <img src="https://res.cloudinary.com/dqqeavica/image/upload/v1764111247/carpeta_drive_epbrhp.webp" alt="CUENTA">
          </button>
        </div>

        <div id="sec-actividades" class="section-content hidden">
          <div id="actividades-blocks"></div>
        </div>

        <h3 style="color:var(--primary); margin-top:18px;">OBSERVACI√ìN (si vas a devolver la cuenta)</h3>
        <textarea id="rc-observaciones" rows="4" placeholder="Escribe la observaci√≥n para devolver‚Ä¶"></textarea>

        <div class="btn-row spaced">
          <button id="rc-aprobar" class="btn-primary">Aprobar</button>
          <button id="rc-devolver" class="danger">Devolver</button>
          <button id="rc-volver" class="danger">Regresar</button>
        </div>
      </div>
    </section>

    <!-- VISTA REQUERIMIENTO -->
    <section id="view-requerimientos" class="view">
      <div class="card">
        <h2 style="color:var(--primary)">REQUERIMIENTO</h2>
        <div id="req-list" class="list-grid"></div>
        <div class="btn-row spaced">
          <button id="req-volver" class="danger">REGRESAR</button>
        </div>
      </div>
    </section>

    <!-- MODAL REQUERIMIENTO -->
    <div id="modal-requerimiento" class="overlay hidden" aria-hidden="true">
      <div class="scrim" id="modal-req-scrim"></div>
      <aside class="panel" style="width:min(520px,95vw); transform:none; left:50%; top:50%; translate:-50% -50%; border-radius:18px; background:#fff; color:#000; box-shadow:0 10px 24px rgba(0,0,0,.45); padding:24px;">
        <h3 style="color:var(--primary); text-align:center;">Redacta tu Requerimiento</h3>
        <textarea id="modal-req-text" rows="5" placeholder="Redacta el requerimiento" style="margin-top:12px;"></textarea>
        <div class="btn-row" style="margin-top:18px;">
          <button id="modal-req-enviar" class="btn-primary">Enviar</button>
          <button id="modal-req-cancelar" class="danger">Cancelar</button>
        </div>
      </aside>
    </div>

    <!-- VISTA COMUNICADOS -->
    <section id="view-comunicados" class="view">
      <div class="card narrow">
        <h2 style="color:var(--primary)">EMITE COMUNICADO</h2>
        <textarea id="comunicado-text" rows="6" placeholder="Escribe tu comunicado"></textarea>
        <div class="btn-row spaced">
          <button id="comunicado-enviar" class="btn-primary">Enviar</button>
          <button id="comunicado-volver" class="danger">Regresar</button>
        </div>
      </div>
    </section>

    <!-- VISTA SOPORTE -->
    <section id="view-soporte" class="view">
      <div class="card narrow">
        <h2 style="color:var(--primary)">¬øQU√â NECESITAS?</h2>
        <textarea id="soporte-text" rows="6" placeholder="Redacta detalladamente tu pregunta o sugerencia"></textarea>
        <div class="btn-row spaced">
          <button id="soporte-enviar" class="btn-primary">Enviar</button>
          <button id="soporte-volver" class="danger">Regresar</button>
        </div>
      </div>
    </section>

    <!-- OVERLAY MEN√ö -->
    <div class="overlay" id="overlay">
      <div class="scrim" id="ovlClose"></div>
      <aside class="panel">
        <div class="btn-row" style="margin-bottom:8px;">
          <button class="menu-btn danger" id="btn-ovl-cerrar">Cerrar Sesi√≥n</button>
          <button class="menu-btn" id="btn-ovl-back">Atr√°s</button>
        </div>
        <div class="image-center">
          <img alt="logo" src="https://res.cloudinary.com/dqqeavica/image/upload/v1763930524/menu_t9xli7.gif" style="max-width:180px;border-radius:14px;" />
        </div>
        <h3 style="margin:8px 0 12px;">Opciones</h3>
        <button class="menu-btn" id="ovl-actualizar">Actualizar Firma e Imagen</button>
        <button class="menu-btn" id="ovl-contratistas">Contratistas</button>
        <button class="menu-btn" id="ovl-revisar">Revisar Cuentas</button>
        <button class="menu-btn" id="ovl-requerimiento">Requerimiento</button>
        <button class="menu-btn" id="ovl-comunicados">Comunicados</button>
        <button class="menu-btn" id="ovl-soporte">Soporte</button>
        <button class="menu-btn" id="btn-instalar" style="display:none;">Instalar la App üì≤</button>
        <div style="height:24px"></div>
        <img class="brand" alt="Banner" src="https://res.cloudinary.com/dqqeavica/image/upload/v1764758798/ALCALDIA_FLANDES_DIGITAL_x1kxxo.png" />
        <p class="center muted">Copyright ¬© <b>GOBIERNO DIGITAL</b></p>
      </aside>
    </div>

  </div>

<script>
/* ================== CONFIG PRINCIPAL ================== */
const API_BASE = 'https://script.google.com/macros/s/AKfycbxODAokpEb3RRzeVlrriddyzbYxRwcLPh2ymehmBU_iM7zx4hLCWwcuHH5mV1qcIc0xAw/exec';
const BUILDERBOT_ENDPOINT = 'https://app.builderbot.cloud/api/v2/ff37a123-12b0-4fdc-9866-f3e2daf389fb/messages';
const BUILDERBOT_API_KEY  = 'bb-7f9ef630-5cfc-4ba4-9258-5e7cecbb4f65';

/* ================== SONIDOS ================== */
const SOUNDS = {
  question: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Pay_fail_ls2aif.mp3',
  info: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Default_notification_pkp4wr.mp3',
  success: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Pay_success_t5aawh.mp3',
  error: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Low_battery_d5qua1.mp3',
  warning: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Low_battery_d5qua1.mp3',
  login: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Siri_star_g1owy4.mp3',
  logout: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Siri_End_kelv02.mp3',
  back: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Keyboard_Enter_b9k2dc.mp3'
};
function playSoundOnce(url){
  try{ const a=new Audio(url); a.preload='auto'; a.play().catch(()=>{});}catch(_){}
}
if(window.Swal && typeof Swal.fire==='function'){
  const __fire=Swal.fire.bind(Swal);
  Swal.fire=function(opts={},...rest){
    try{ const icon=opts.icon||opts.type; if(icon && SOUNDS[icon]) playSoundOnce(SOUNDS[icon]); }catch(_){}
    return __fire(opts,...rest);
  };
}

/* ================== LOADER ================== */
const loader=document.getElementById('loader');
let loadingCount=0, loaderTimer=null;
function startLoading(){ loadingCount++; if(loadingCount===1){ loaderTimer=setTimeout(()=>{ loader.classList.remove('hidden'); loaderTimer=null; },120);} }
function stopLoading(){ if(loadingCount===0) return; loadingCount--; if(loadingCount===0){ if(loaderTimer){ clearTimeout(loaderTimer); loaderTimer=null;} loader.classList.add('hidden'); }}

/* ================== API HELPERS ================== */
async function apiGet(action, params={}){
  startLoading();
  try{
    const url=new URL(API_BASE);
    url.search=new URLSearchParams({action,...params}).toString();
    const r=await fetch(url.toString(),{method:'GET'});
    const j=await r.json();
    if(!j.ok) throw new Error(j.error||'Error');
    return j.data;
  }finally{ stopLoading(); }
}
async function apiPost(action, body={}){
  startLoading();
  try{
    const url=API_BASE+'?action='+encodeURIComponent(action);
    const r=await fetch(url,{
      method:'POST',
      headers:{'Content-Type':'text/plain;charset=utf-8'},
      body:JSON.stringify(body)
    });
    const j=await r.json();
    if(!j.ok) throw new Error(j.error||'Error');
    return j.data;
  }finally{ stopLoading(); }
}

/* ================== BUILDERBOT ================== */
function normalizeNumber(raw){
  let num=String(raw||'').replace(/\D/g,'');
  if(!num) return '';
  if(num.length===10 && !num.startsWith('57')) num='57'+num;
  if(!(num.length===12 && num.startsWith('57'))) return '';
  return num;
}
function sendBuilderbotMessage(destino,mensaje){
  const numberField=String(destino||'').trim();
  if(!numberField) return;
  fetch(BUILDERBOT_ENDPOINT,{
    method:'POST',
    headers:{'Content-Type':'application/json','x-api-builderbot':BUILDERBOT_API_KEY},
    body:JSON.stringify({messages:{content:mensaje},number:numberField,checkIfExists:false})
  }).catch(()=>{});
}

/* ================== ESTADO ================== */
let currentUser=null; // { cedula, supervisor, firmaId, imagenId }

/* ================== VISTAS ================== */
function showView(id){
  for(const el of document.querySelectorAll('.view')) el.classList.remove('active');
  const v=document.getElementById(id);
  if(v) v.classList.add('active');
  window.scrollTo({top:0,behavior:'smooth'});
}

/* ================== TOGGLE C√âDULA ================== */
const loginCedula=document.getElementById('login-cedula');
const toggleCedulaBtn=document.getElementById('toggle-cedula');
toggleCedulaBtn.addEventListener('click',()=>{
  const oculto=loginCedula.type==='password';
  loginCedula.type=oculto?'text':'password';
  const icon=oculto
    ? 'https://res.cloudinary.com/dqqeavica/image/upload/v1764084782/Ocultar_lgdxpd.png'
    : 'https://res.cloudinary.com/dqqeavica/image/upload/v1764084782/Mostrar_yymceh.png';
  toggleCedulaBtn.setAttribute('aria-label', oculto?'Ocultar c√©dula':'Mostrar c√©dula');
  toggleCedulaBtn.innerHTML='<img src="'+icon+'" alt="">';
  playSoundOnce(SOUNDS.info);
});

/* ================== LOGIN ================== */
document.getElementById('btn-login').addEventListener('click', async ()=>{
  const cedula=(loginCedula.value||'').trim();
  if(cedula===''){
    Swal.fire({icon:'warning',title:'Ingresa la C√©dula',text:'Campo requerido.'});
    return;
  }
  if(!/^\d{6,10}$/.test(cedula)){
    Swal.fire({icon:'warning',title:'C√©dula inv√°lida',text:'Debe tener de 6 a 10 d√≠gitos SIN PUNTOS NI ESPACIOS'});
    return;
  }
  try{
    const res=await apiGet('loginSupervisor',{cedula});
    if(!res || !res.encontrado){
      // Abrir WhatsApp para solicitar acceso
      const soporte='573103230712';
      const mensaje=
        'Buen d√≠a *Oscar*%0A%0ANo tengo acceso a la *App Supervisi√≥n*.%0A' +
        'Mi c√©dula: *'+cedula+'*%0A' +
        'Te dejo mis datos:%0A*Nombre Completo:*%0A*Celular:*';
      const esMovil=/android|iphone|ipad|mobile/i.test(navigator.userAgent);
      const urlWA= esMovil
        ? 'whatsapp://send?phone='+soporte+'&text='+mensaje
        : 'https://api.whatsapp.com/send?phone='+soporte+'&text='+mensaje;
      window.open(urlWA,'_blank');
      await Swal.fire({icon:'error',title:'SIN ACCESO',html:'Se abri√≥ WhatsApp para que solicites la habilitaci√≥n.',timer:6000,showConfirmButton:false});
      return;
    }
    currentUser={
      cedula,
      supervisor: res.supervisor||'',
      firmaId: res.firmaId||'',
      imagenId: res.imagenId||'' // nuevo
    };
    if(!currentUser.firmaId){
      await Swal.fire({icon:'success',title:`${currentUser.supervisor} completa tu registro`,text:'Solo debes ingresar la imagen de tu firma',confirmButtonText:'Ok'});
      showView('view-completar');
    }else{
      renderInicio();
      playSoundOnce(SOUNDS.login);
      showView('view-inicio');
    }
  }catch(e){
    Swal.fire({icon:'error',title:'Error',text:e.message});
  }
});

/* ================== COMPLETAR / ACTUALIZAR REGISTRO ================== */
async function compressImage(file,maxDim=1280,quality=0.75){
  return new Promise((resolve,reject)=>{
    try{
      const reader=new FileReader();
      reader.onload=ev=>{
        const img=new Image();
        img.onload=()=>{
          const canvas=document.createElement('canvas');
          let {width,height}=img;
          const scale=Math.min(1,maxDim/Math.max(width,height));
          width=Math.round(width*scale); height=Math.round(height*scale);
          canvas.width=width; canvas.height=height;
          const ctx=canvas.getContext('2d');
          ctx.drawImage(img,0,0,width,height);
          resolve(canvas.toDataURL('image/jpeg',quality));
        };
        img.onerror=()=>reject(new Error('No se pudo procesar la imagen.'));
        img.src=ev.target.result;
      };
      reader.onerror=()=>reject(new Error('No se pudo leer el archivo.'));
      reader.readAsDataURL(file);
    }catch(e){ reject(e); }
  });
}
let regFirmaDataUrl='', regFotoDataUrl='';
document.getElementById('reg-firma')?.addEventListener('change',async (e)=>{
  const file=e.target.files && e.target.files[0];
  const preview=document.getElementById('reg-firma-preview');
  if(!file){ regFirmaDataUrl=''; preview.style.display='none'; preview.src=''; return; }
  try{
    regFirmaDataUrl=await compressImage(file,1280,0.85);
  }catch(_){
    const rdr=new FileReader();
    rdr.onload=ev=>{ regFirmaDataUrl=ev.target.result; };
    rdr.readAsDataURL(file);
  }
  preview.src=regFirmaDataUrl; preview.style.display='block';
  playSoundOnce(SOUNDS.info);
});
document.getElementById('reg-foto')?.addEventListener('change',async (e)=>{
  const file=e.target.files && e.target.files[0];
  const preview=document.getElementById('reg-preview');
  if(!file){ regFotoDataUrl=''; preview.style.display='none'; preview.src=''; return; }
  try{
    regFotoDataUrl=await compressImage(file,1280,0.80);
  }catch(_){
    const rdr=new FileReader();
    rdr.onload=ev=>{ regFotoDataUrl=ev.target.result; };
    rdr.readAsDataURL(file);
  }
  preview.src=regFotoDataUrl; preview.style.display='block';
  playSoundOnce(SOUNDS.info);
});

document.getElementById('btn-guardar-reg').addEventListener('click',async ()=>{
  if(!currentUser?.cedula){ Swal.fire({icon:'warning',title:'Sesi√≥n inv√°lida'}); return; }
  if(!regFirmaDataUrl){
    Swal.fire({icon:'warning',title:'Firma requerida'}); return;
  }
  try{
    const data=await apiPost('guardarFirmaImagenSupervisor',{
      cedula:currentUser.cedula,
      firmaDataUrl:regFirmaDataUrl,
      imagenDataUrl:regFotoDataUrl||''
    });
    currentUser.firmaId=data.firmaId||'';
    currentUser.imagenId=data.imagenId||'';
    Swal.fire({icon:'success',title:'Datos guardados',timer:1800,showConfirmButton:false});
    renderInicio();
    showView('view-inicio');
    playSoundOnce(SOUNDS.success);
  }catch(e){
    Swal.fire({icon:'error',title:'Error',text:e.message});
  }
});
document.getElementById('btn-cancelar-reg').addEventListener('click',()=>{
  regFirmaDataUrl=''; regFotoDataUrl='';
  showView('view-inicio');
  playSoundOnce(SOUNDS.back);
});

/* ================== INICIO ================== */
function driveThumbById(id){ return id?('https://drive.google.com/thumbnail?sz=w1000&id='+id):''; }
function renderInicio(){
  const avatar=document.getElementById('inicio-avatar');
  if(currentUser?.imagenId){
    avatar.src=driveThumbById(currentUser.imagenId);
  }else{
    avatar.src='https://res.cloudinary.com/dqqeavica/image/upload/v1758738139/user_zefosv.png';
  }
  document.getElementById('inicio-nombre').textContent = currentUser?.supervisor || '';
  document.getElementById('inicio-rol').textContent = 'SUPERVISOR(A)';
  const imgFirma=document.getElementById('inicio-firma');
  if(currentUser?.firmaId){
    imgFirma.src=driveThumbById(currentUser.firmaId);
    imgFirma.classList.remove('hidden');
  }else{
    imgFirma.classList.add('hidden');
  }
}
document.getElementById('btn-logout').addEventListener('click',()=>{
  playSoundOnce(SOUNDS.logout);
  currentUser=null;
  loginCedula.value='';
  regFirmaDataUrl=''; regFotoDataUrl='';
  showView('view-login');
});

/* ================== OVERLAY MEN√ö ================== */
const overlay=document.getElementById('overlay');
const panel=overlay.querySelector('.panel');
function openOverlay(){ overlay.classList.add('open'); playSoundOnce(SOUNDS.login); }
function closeOverlay(){ overlay.classList.remove('open'); playSoundOnce(SOUNDS.back); }
document.getElementById('btn-open-menu').addEventListener('click',openOverlay);
document.getElementById('ovlClose').addEventListener('click',closeOverlay);
document.getElementById('btn-ovl-back').addEventListener('click',closeOverlay);
document.getElementById('btn-ovl-cerrar').addEventListener('click',()=>{
  closeOverlay();
  document.getElementById('btn-logout').click();
});
document.getElementById('ovl-actualizar').addEventListener('click',()=>{ closeOverlay(); showView('view-completar'); });
document.getElementById('ovl-contratistas').addEventListener('click',async ()=>{ closeOverlay(); await cargarContratistas(); showView('view-contratistas'); });
document.getElementById('ovl-revisar').addEventListener('click',async ()=>{ closeOverlay(); await cargarCuentas(); showView('view-revision'); });
document.getElementById('ovl-requerimiento').addEventListener('click',async ()=>{ closeOverlay(); await cargarRequerimientosBase(); showView('view-requerimientos'); });
document.getElementById('ovl-comunicados').addEventListener('click',()=>{ closeOverlay(); showView('view-comunicados'); });
document.getElementById('ovl-soporte').addEventListener('click',()=>{ closeOverlay(); showView('view-soporte'); });

/* ================== CONTRATISTAS ================== */
let CONTR_DATA=[];
async function cargarContratistas(){
  try{
    const list=await apiGet('listContratistasSupervisor',{supervisor:currentUser?.supervisor||''});
    CONTR_DATA=Array.isArray(list)?list:[];
    pintarContratistas(CONTR_DATA);
    document.getElementById('contr-count').textContent=String(CONTR_DATA.length||0);
  }catch(e){
    CONTR_DATA=[]; pintarContratistas(CONTR_DATA);
    Swal.fire({icon:'error',title:'Error',text:e.message});
  }
}
function pintarContratistas(list){
  const wrap=document.getElementById('contr-list');
  wrap.innerHTML='';
  if(!list.length){ wrap.innerHTML='<p class="muted center">No hay contratistas asignados.</p>'; return; }
  for(const c of list){
    const card=document.createElement('div'); card.className='item-card';
    const header=document.createElement('div'); header.className='item-header';
    const title=document.createElement('p'); title.className='item-title'; title.textContent=(c.nombre||'');
    header.appendChild(title); card.appendChild(header);

    ['CC: '+(c.documento||''),'SECRETAR√çA: '+(c.secretaria||''),'SUPERVISOR(A): '+(c.supervisor||''),
     'CONTRATO: '+(c.contrato||'')+' de '+(c.fechaContrato||''),
     'INICIO: '+(c.fechaInicio||''),'TERMINO: '+(c.fechaTermino||'')].forEach(t=>{
       const p=document.createElement('p'); p.className='item-sub'; p.textContent=t; card.appendChild(p);
     });

    const btnRow=document.createElement('div'); btnRow.className='btn-row';
    const btnDet=document.createElement('button'); btnDet.textContent='MOSTRAR DETALLES';
    btnDet.addEventListener('click',async ()=>{
      playSoundOnce(SOUNDS.login);
      try{
        const d=await apiGet('detallesContratista',{documento:c.documento});
        const lines=[];
        if(d){
          lines.push(`<b>NOMBRE:</b> ${d.nombre||''}`);
          lines.push(`<b>CC:</b> ${d.documento||''}`);
          lines.push(`<b>SECRETAR√çA:</b> ${d.secretaria||''}`);
          lines.push(`<b>SUPERVISOR(A):</b> ${d.supervisor||''}`);
          lines.push(`<b>CONTRATO:</b> ${d.contrato||''} de ${d.fechaContrato||''}`);
          lines.push(`<b>OBJETO:</b> ${d.objeto||''}`);
          lines.push(`<b>FECHA INICIO:</b> ${d.fechaInicio||''}`);
          lines.push(`<b>FECHA FIN:</b> ${d.fechaTermino||''}`);
          for(let i=1;i<=26;i++){ const v=d['obligacion'+i]; if(v && v!=='-') lines.push(`<b>OBLIGACI√ìN ${i}:</b> ${v}`); }
        }
        Swal.fire({
          icon:'info',
            title:'DETALLES',
            html: lines.map(l=>`<p style="text-align:left;margin:4px 0;">${l}</p>`).join(''),
            width:'680px'
          });
      }catch(e){ Swal.fire({icon:'error',title:'Error',text:e.message}); }
    });
    btnRow.appendChild(btnDet);
    card.appendChild(btnRow);
    wrap.appendChild(card);
  }
}
document.getElementById('contr-filter').addEventListener('input',()=>{
  const q=document.getElementById('contr-filter').value.trim().toLowerCase();
  const filtered=CONTR_DATA.filter(c=>[c.nombre,c.documento,c.secretaria,c.supervisor,c.telefono]
    .some(v=>String(v||'').toLowerCase().includes(q)));
  pintarContratistas(filtered);
  document.getElementById('contr-count').textContent=String(filtered.length||0);
});
document.getElementById('contr-volver').addEventListener('click',()=>{
  document.getElementById('contr-filter').value='';
  pintarContratistas(CONTR_DATA);
  renderInicio();
  showView('view-inicio');
  playSoundOnce(SOUNDS.back);
});

/* ================== REVISI√ìN LISTA ================== */
let CUENTAS_DATA=[];
async function cargarCuentas(){
  try{
    const list=await apiGet('listCuentasSupervisor',{supervisor:currentUser?.supervisor||''});
    CUENTAS_DATA=Array.isArray(list)?list:[];
    pintarCuentas(CUENTAS_DATA);
    document.getElementById('cuentas-count').textContent=String(CUENTAS_DATA.length||0);
  }catch(e){
    CUENTAS_DATA=[]; pintarCuentas(CUENTAS_DATA);
    Swal.fire({icon:'error',title:'Error',text:e.message});
  }
}
function pintarCuentas(list){
  const wrap=document.getElementById('cuentas-list');
  wrap.innerHTML='';
  if(!list.length){ wrap.innerHTML='<p class="muted center">No hay cuentas ingresadas.</p>'; return; }
  for(const c of list){
    const card=document.createElement('div'); card.className='item-card';
    const header=document.createElement('div'); header.className='item-header';
    const title=document.createElement('p'); title.className='item-title'; title.textContent=(c.nombre||'');
    header.appendChild(title); card.appendChild(header);

    const sub1=document.createElement('p'); sub1.className='item-sub'; sub1.textContent='CC: '+(c.documento||''); card.appendChild(sub1);
    const sub2=document.createElement('p'); sub2.className='item-sub'; sub2.textContent='INFORME: '+(c.informe||'')+' de '+(c.totalInformes||''); card.appendChild(sub2);

    const btnRow=document.createElement('div'); btnRow.className='btn-row';
    const btnRev=document.createElement('button'); btnRev.textContent='REVISAR';
    btnRev.addEventListener('click',async ()=>{
      playSoundOnce(SOUNDS.login);
      try{
        const det=await apiGet('revisarCuentaDataSupervisor',{documento:c.documento, supervisor:currentUser?.supervisor||''});
        if(!det){ Swal.fire({icon:'info',title:'No encontrado'}); return; }
        REV_CUENTA=det;
        resetSeccionesRevision();
        renderRevisionCuenta();
        showView('view-revisar-cuenta');
      }catch(e){ Swal.fire({icon:'error',title:'Error',text:e.message}); }
    });
    btnRow.appendChild(btnRev);
    card.appendChild(btnRow);
    wrap.appendChild(card);
  }
}
document.getElementById('cuentas-filter').addEventListener('input',()=>{
  const q=document.getElementById('cuentas-filter').value.trim().toLowerCase();
  const filtered=CUENTAS_DATA.filter(c=>[c.nombre,c.documento,c.informe,c.totalInformes]
    .some(v=>String(v||'').toLowerCase().includes(q)));
  pintarCuentas(filtered);
  document.getElementById('cuentas-count').textContent=String(filtered.length||0);
});
document.getElementById('revision-volver').addEventListener('click',()=>{
  document.getElementById('cuentas-filter').value='';
  pintarCuentas(CUENTAS_DATA);
  renderInicio();
  showView('view-inicio');
  playSoundOnce(SOUNDS.back);
});

/* ================== REVISAR CUENTA (DETALLE COMPLETO) ================== */
let REV_CUENTA=null;

function resetSeccionesRevision(){
  const parts=[
    {sec:'sec-contrato',btn:'btn-toggle-contrato',label:'Ver Informaci√≥n del Contrato'},
    {sec:'sec-informe',btn:'btn-toggle-informe',label:'Ver Relaci√≥n de Informe y Pago'},
    {sec:'sec-planilla',btn:'btn-toggle-planilla',label:'Ver Relaci√≥n de Planilla'},
    {sec:'sec-planilla2',btn:'btn-toggle-planilla2',label:'Ver Relaci√≥n de Planilla Anexa'},
    {sec:'sec-actividades',btn:'btn-toggle-actividades',label:'Ver Relaci√≥n de Actividades'}
  ];
  parts.forEach(({sec,btn,label})=>{
    const s=document.getElementById(sec);
    const b=document.getElementById(btn);
    if(s) s.classList.add('hidden');
    if(b) b.textContent=label;
  });
}

function renderRevisionCuenta(){
  const c=REV_CUENTA?.contratista;
  const cu=REV_CUENTA?.cuenta;
  const rcTitle=document.getElementById('rc-title');
  const rcBody=document.getElementById('rc-body');
  rcTitle.textContent='REVISI√ìN DE CUENTA N¬∞ '+(cu?.informe||'')+' de '+(c?.nombre||'');
  const baseInfo=[
    `<b>DOCUMENTO:</b> ${c?.documento||''}`,
    `<b>SECRETAR√çA:</b> ${c?.secretaria||''}`,
    `<b>SUPERVISOR(A):</b> ${c?.supervisor||''}`
  ];
  rcBody.innerHTML=baseInfo.map(x=>`<p>${x}</p>`).join('');

  // Contrato
  const sContrato=document.getElementById('sec-contrato');
  sContrato.innerHTML=[
    `<b>CONTRATO N¬∞:</b> ${c?.contrato||''}`,
    `<b>FECHA DE CONTRATO:</b> ${c?.fechaContrato||''}`,
    `<b>FECHA DE INICIO:</b> ${c?.fechaInicio||''}`,
    `<b>FECHA DE FIN:</b> ${c?.fechaFin||c?.fechaTermino||''}`,
    `<b>OBJETO:</b> ${c?.objeto||''}`
  ].map(p=>`<p>${p}</p>`).join('');

  // Informe/Pago
  const sInforme=document.getElementById('sec-informe');
  sInforme.innerHTML=[
    `<h4 style="margin:4px 0;color:var(--primary)">RELACI√ìN DE INFORME</h4>`,
    `<p><b>FECHA RADICACI√ìN:</b> ${cu?.fechaRadicacion||''}</p>`,
    `<p><b>INFORME:</b> ${cu?.informe||''} de ${cu?.totalInformes||''}</p>`,
    `<p><b>INICIO RATIFICADO:</b> ${cu?.inicioRatificar||''}</p>`,
    `<p><b>FIN RATIFICADO:</b> ${cu?.finRatificar||''}</p>`,
    `<h4 style="margin:14px 0 4px;color:var(--primary)">RELACI√ìN DE PAGO</h4>`,
    `<p><b>SALDO ACTUAL:</b> ${cu?.saldoActual||''}</p>`,
    `<p><b>VALOR COBRADO:</b> ${cu?.menos||''}</p>`,
    `<p><b>NUEVO SALDO:</b> ${cu?.nuevoSaldo||''}</p>`
  ].join('');

  // Planillas
  const sPlanilla=document.getElementById('sec-planilla');
  sPlanilla.innerHTML=`<p><i>Esta secci√≥n se representar√° cuando agregues campos de planilla en el GS si lo deseas.</i></p>`;
  const sPlanilla2=document.getElementById('sec-planilla2');
  sPlanilla2.innerHTML=`<p><i>Esta secci√≥n se representar√° cuando agregues planilla anexa.</i></p>`;

  // Actividades / Obligaciones / Evidencias (si vienen)
  const blocksWrap=document.getElementById('actividades-blocks');
  blocksWrap.innerHTML='';
  const actividades=REV_CUENTA?.actividades||[];
  const evidencias=REV_CUENTA?.evidencias||[];
  const obligaciones=REV_CUENTA?.obligaciones||[];
  const total = Math.max(obligaciones.length, actividades.length, evidencias.length);

  function extraerDriveId(url){
    if(!url) return '';
    const primera=String(url).trim().split(/\s+/)[0];
    const patrones=[
      /\/d\/([A-Za-z0-9_-]{10,})/,
      /id=([A-Za-z0-9_-]{10,})/,
      /\/file\/d\/([A-Za-z0-9_-]{10,})/,
      /open\?[^#]*id=([A-Za-z0-9_-]{10,})/
    ];
    for(const rx of patrones){
      const m=primera.match(rx);
      if(m) return m[1];
    }
    return '';
  }
  function evidenciaThumb(url){
    const id=extraerDriveId(url);
    return id ? 'https://drive.google.com/thumbnail?sz=w1000&id='+id : url;
  }
  function evidenciaFull(url){
    if(!url) return '';
    const primera=String(url).trim().split(/\s+/)[0];
    const id=extraerDriveId(primera);
    return id ? 'https://drive.google.com/uc?export=view&id='+id : primera;
  }
  function abrirZoomEvidencia(src,titulo){
    const overlay=document.createElement('div');
    overlay.style.position='fixed'; overlay.style.inset='0';
    overlay.style.background='rgba(0,0,0,.75)';
    overlay.style.zIndex='10000'; overlay.style.display='flex';
    overlay.style.alignItems='center'; overlay.style.justifyContent='center';
    overlay.style.padding='24px';

    const box=document.createElement('div');
    box.style.maxWidth='90%'; box.style.maxHeight='90%'; box.style.position='relative';
    box.style.background='#fff'; box.style.borderRadius='16px'; box.style.padding='16px';
    box.style.boxShadow='0 8px 24px rgba(0,0,0,.4)'; box.style.display='flex';
    box.style.flexDirection='column'; box.style.alignItems='center'; box.style.gap='12px';

    const titleEl=document.createElement('h3'); titleEl.textContent=titulo;
    titleEl.style.margin='0'; titleEl.style.color='var(--primary)';

    const img=document.createElement('img');
    img.style.maxWidth='100%'; img.style.maxHeight='70vh'; img.style.borderRadius='12px';
    img.style.objectFit='contain'; img.alt=titulo;

    const loaderMsg=document.createElement('p'); loaderMsg.textContent='Cargando imagen‚Ä¶';
    loaderMsg.style.margin='0'; loaderMsg.style.fontSize='.85rem';

    img.addEventListener('error',()=>{
      if(src.includes('uc?export=view&id=')){
        const idMatch=src.match(/id=([A-Za-z0-9_-]{10,})/);
        if(idMatch){ img.src='https://drive.google.com/thumbnail?sz=w1000&id='+idMatch[1]; loaderMsg.textContent='(Vista alternativa)'; }
      }else loaderMsg.textContent='No se pudo cargar la evidencia.';
    });
    img.addEventListener('load',()=> loaderMsg.textContent='');
    img.src=src;

    const cerrarBtn=document.createElement('button');
    cerrarBtn.textContent='Cerrar'; cerrarBtn.className='btn-primary';
    cerrarBtn.style.maxWidth='160px';
    cerrarBtn.addEventListener('click',()=> document.body.removeChild(overlay));

    overlay.addEventListener('click',(e)=>{ if(e.target===overlay) document.body.removeChild(overlay); });

    box.appendChild(titleEl); box.appendChild(img); box.appendChild(loaderMsg); box.appendChild(cerrarBtn);
    overlay.appendChild(box);
    document.body.appendChild(overlay);
  }

  for(let i=1;i<=total;i++){
    const oblig=obligaciones[i-1];
    const act=actividades[i-1];
    const evid=evidencias[i-1];
    if(![oblig,act,evid].some(v=>v && v!=='-')) continue;
    const block=document.createElement('div'); block.className='oblig-block';
    const titulo=document.createElement('p'); titulo.className='oblig-title'; titulo.textContent='OBLIGACI√ìN N¬∞ '+i;
    block.appendChild(titulo);
    if(oblig && oblig!=='-'){
      const ob=document.createElement('p'); ob.className='oblig-sub'; ob.textContent=oblig; block.appendChild(ob);
    }
    if(act && act!=='-'){
      const ac=document.createElement('p'); ac.className='oblig-sub'; ac.innerHTML='<b>Actividades:</b> '+act;
      block.appendChild(ac);
    }
    if(evid && evid!=='-'){
      const evDiv=document.createElement('div'); evDiv.className='evidence-grid';
      const img=document.createElement('img'); img.className='evidence-thumb';
      img.src=evidenciaThumb(evid); img.alt='Evidencia '+i;
      img.addEventListener('click',()=> abrirZoomEvidencia(evidenciaFull(evid),'Evidencia '+i));
      evDiv.appendChild(img); block.appendChild(evDiv);
    }
    blocksWrap.appendChild(block);
  }

  // Bot√≥n carpeta cuenta
  const cuentaBtn=document.getElementById('btn-abrir-carpeta-cuenta');
  if(cu?.idCuenta){
    cuentaBtn.classList.remove('hidden');
    cuentaBtn.dataset.subId=String(cu.idCuenta);
  }else{
    cuentaBtn.classList.add('hidden');
    delete cuentaBtn.dataset.subId;
  }
}
document.getElementById('btn-abrir-carpeta-cuenta').addEventListener('click',()=>{
  playSoundOnce(SOUNDS.login);
  const subId=document.getElementById('btn-abrir-carpeta-cuenta').dataset.subId || '';
  if(subId) window.open('https://drive.google.com/drive/folders/'+subId,'_blank');
  else Swal.fire({icon:'info',title:'Sin carpeta de cuenta'});
});

['btn-toggle-contrato','btn-toggle-informe','btn-toggle-planilla','btn-toggle-planilla2','btn-toggle-actividades']
  .forEach(id=>{
    const btn=document.getElementById(id);
    btn.addEventListener('click',()=>{
      playSoundOnce(SOUNDS.info);
      const map={
        'btn-toggle-contrato':['sec-contrato','Ver Informaci√≥n del Contrato','Ocultar Informaci√≥n del Contrato'],
        'btn-toggle-informe':['sec-informe','Ver Relaci√≥n de Informe y Pago','Ocultar Relaci√≥n de Informe y Pago'],
        'btn-toggle-planilla':['sec-planilla','Ver Relaci√≥n de Planilla','Ocultar Relaci√≥n de Planilla'],
        'btn-toggle-planilla2':['sec-planilla2','Ver Relaci√≥n de Planilla Anexa','Ocultar Relaci√≥n de Planilla Anexa'],
        'btn-toggle-actividades':['sec-actividades','Ver Relaci√≥n de Actividades','Ocultar Relaci√≥n de Actividades']
      };
      const [secId,showTxt,hideTxt]=map[id];
      const sec=document.getElementById(secId);
      const visible=!sec.classList.contains('hidden');
      if(visible){ sec.classList.add('hidden'); btn.textContent=showTxt; }
      else{ sec.classList.remove('hidden'); btn.textContent=hideTxt; }
    });
  });

document.getElementById('rc-volver').addEventListener('click',()=>{
  resetSeccionesRevision();
  document.getElementById('rc-observaciones').value='';
  showView('view-revision');
  playSoundOnce(SOUNDS.back);
});

document.getElementById('rc-aprobar').addEventListener('click',async ()=>{
  if(!REV_CUENTA?.cuenta) { Swal.fire({icon:'warning',title:'Sin cuenta cargada'}); return; }
  try{
    const documento=REV_CUENTA.contratista.documento;
    const informe=REV_CUENTA.cuenta.informe;
    await apiPost('aprobarCuentaSupervisor',{documento,informe,supervisor:currentUser?.supervisor||''});

    // Mensajes
    const nombre=REV_CUENTA.contratista.nombre;
    const supervisor=currentUser?.supervisor||'';
    const telContr=normalizeNumber(REV_CUENTA.contratista.telefono);
    const grupoId='HpfMVceAaM96quyxP3YSL1';

    const msgContr=
      'Estimado(a) *'+nombre+'*\n\n'+
      '¬°He firmado el Informe de Supervisi√≥n y solicitado al √°rea de contrataci√≥n validar tu *Cuenta N¬∞ '+informe+'*!,\n\n'+
      'Espera atentamente la aprobaci√≥n.\n\n'+
      'Cordialmente,\n\n*'+supervisor+'*\n> Supervisor(a)';

    const msgGrupo=
      'Buen d√≠a *Equipo de Contrataci√≥n*\n\n'+
      '¬°Por favor solicito la revisi√≥n de la *Cuenta N¬∞ '+informe+'*! Del contratista *'+nombre+'*,\n\n'+
      'Cordialmente,\n\n*'+supervisor+'*\n> Supervisor(a)';

    if(telContr) sendBuilderbotMessage(telContr,msgContr);
    sendBuilderbotMessage(grupoId,msgGrupo);

    Swal.fire({icon:'success',title:'Cuenta REVISADA POR SUPERVISOR',timer:1800,showConfirmButton:false});
    await cargarCuentas();
    showView('view-revision');
    playSoundOnce(SOUNDS.success);
  }catch(e){
    Swal.fire({icon:'error',title:'Error',text:e.message});
  }
});

document.getElementById('rc-devolver').addEventListener('click',async ()=>{
  if(!REV_CUENTA?.cuenta){ Swal.fire({icon:'warning',title:'Sin cuenta cargada'}); return; }
  const observ=(document.getElementById('rc-observaciones').value||'').trim();
  if(!observ){ Swal.fire({icon:'warning',title:'Observaci√≥n requerida'}); return; }
  try{
    const documento=REV_CUENTA.contratista.documento;
    const informe=REV_CUENTA.cuenta.informe;
    await apiPost('devolverCuentaSupervisor',{documento,informe,observaciones:observ});

    const nombre=REV_CUENTA.contratista.nombre;
    const supervisor=currentUser?.supervisor||'';
    const telContr=normalizeNumber(REV_CUENTA.contratista.telefono);
    const msgDevuelto=
      'Estimado(a) *'+nombre+'*\n\n'+
      'Se ha devuelto tu *Cuenta N¬∞ '+informe+'* por esta inconsistencia:\n\n*'+observ+'*\n\n'+
      'Haz la correcci√≥n desde la *App Contratista* teniendo en cuenta las observaciones anteriores.\n\n'+
      'Cordialmente,\n\n*'+supervisor+'*\n> Supervisor(a)';
    if(telContr) sendBuilderbotMessage(telContr,msgDevuelto);

    Swal.fire({icon:'success',title:'Cuenta Devuelta',timer:1800,showConfirmButton:false});
    await cargarCuentas();
    showView('view-revision');
    playSoundOnce(SOUNDS.success);
  }catch(e){
    Swal.fire({icon:'error',title:'Error',text:e.message});
  }
});

/* ================== REQUERIMIENTOS ================== */
let REQ_DATA=[];
async function cargarRequerimientosBase(){
  try{
    const list=await apiGet('listContratistasSupervisor',{supervisor:currentUser?.supervisor||''});
    REQ_DATA=Array.isArray(list)?list:[];
    pintarReq(REQ_DATA);
  }catch(e){ REQ_DATA=[]; pintarReq(REQ_DATA); }
}
function pintarReq(list){
  const wrap=document.getElementById('req-list');
  wrap.innerHTML='';
  if(!list.length){ wrap.innerHTML='<p class="muted center">No hay contratistas.</p>'; return; }
  for(const c of list){
    const card=document.createElement('div'); card.className='item-card';
    const header=document.createElement('div'); header.className='item-header';
    const title=document.createElement('p'); title.className='item-title'; title.textContent='NOMBRE: '+(c.nombre||'');
    header.appendChild(title); card.appendChild(header);
    const btnRow=document.createElement('div'); btnRow.className='btn-row';
    const btn=document.createElement('button'); btn.textContent='REDACTAR'; btn.addEventListener('click',()=> abrirModalReq(c));
    btnRow.appendChild(btn); card.appendChild(btnRow);
    wrap.appendChild(card);
  }
}
document.getElementById('req-volver').addEventListener('click',()=>{
  renderInicio();
  showView('view-inicio');
  playSoundOnce(SOUNDS.back);
});
let MODAL_REQ_TARGET=null;
function abrirModalReq(c){
  MODAL_REQ_TARGET=c;
  document.getElementById('modal-req-text').value='';
  document.getElementById('modal-requerimiento').classList.remove('hidden');
  playSoundOnce(SOUNDS.login);
}
document.getElementById('modal-req-cancelar').addEventListener('click',()=>{
  document.getElementById('modal-requerimiento').classList.add('hidden');
  playSoundOnce(SOUNDS.back);
});
document.getElementById('modal-req-scrim').addEventListener('click',()=>{
  document.getElementById('modal-requerimiento').classList.add('hidden');
  playSoundOnce(SOUNDS.back);
});
document.getElementById('modal-req-enviar').addEventListener('click',()=>{
  const txt=(document.getElementById('modal-req-text').value||'').trim();
  if(!MODAL_REQ_TARGET || !txt){ Swal.fire({icon:'warning',title:'Texto requerido'}); return; }
  const nombre=(MODAL_REQ_TARGET.nombre||'').trim();
  const tel=normalizeNumber(MODAL_REQ_TARGET.telefono);
  const mensaje=
    'Estimado(a) *'+nombre+'*\n\n'+
    'Tenemos el siguiente requerimiento:\n\n*'+txt+'*\n\n'+
    'Cordialmente,\n\n*'+(currentUser?.supervisor||'SUPERVISOR(A)')+'*\n> Supervisor(a)';
  if(tel) sendBuilderbotMessage(tel,mensaje);
  document.getElementById('modal-requerimiento').classList.add('hidden');
  Swal.fire({icon:'success',title:'Requerimiento enviado',timer:1800,showConfirmButton:false});
});

/* ================== COMUNICADOS ================== */
document.getElementById('comunicado-enviar').addEventListener('click',async ()=>{
  const txt=(document.getElementById('comunicado-text').value||'').trim();
  if(!txt){ Swal.fire({icon:'warning',title:'Texto requerido'}); return; }
  try{
    await apiPost('guardarComunicadoSupervisor',{
      cedula:currentUser?.cedula||'',
      supervisor:currentUser?.supervisor||'',
      comunicado:txt
    });
    Swal.fire({icon:'success',title:'Comunicado enviado',timer:1800,showConfirmButton:false});
    document.getElementById('comunicado-text').value='';
    renderInicio(); showView('view-inicio'); playSoundOnce(SOUNDS.success);
  }catch(e){ Swal.fire({icon:'error',title:'Error',text:e.message}); }
});
document.getElementById('comunicado-volver').addEventListener('click',()=>{
  renderInicio(); showView('view-inicio'); playSoundOnce(SOUNDS.back);
});

/* ================== SOPORTE ================== */
document.getElementById('soporte-enviar').addEventListener('click',async ()=>{
  const txt=(document.getElementById('soporte-text').value||'').trim();
  if(!txt){ Swal.fire({icon:'warning',title:'Texto requerido'}); return; }
  try{
    await apiPost('guardarSoporteSupervisor',{supervisor:currentUser?.supervisor||'',soporte:txt});
    Swal.fire({icon:'success',title:'Solicitud enviada',timer:1800,showConfirmButton:false});
    document.getElementById('soporte-text').value='';
    renderInicio(); showView('view-inicio'); playSoundOnce(SOUNDS.success);
  }catch(e){ Swal.fire({icon:'error',title:'Error',text:e.message}); }
});
document.getElementById('soporte-volver').addEventListener('click',()=>{
  renderInicio(); showView('view-inicio'); playSoundOnce(SOUNDS.back);
});

/* ================== PWA ================== */
let deferredPrompt=null;
function isStandalone(){ return window.matchMedia('(display-mode: standalone)').matches || window.matchMedia('(display-mode: installed)').matches || (window.navigator.standalone===true); }
function isIOS(){ return /(iphone|ipad|ipod)/i.test(navigator.userAgent||''); }
function isMarkedInstalled(){ try{ return localStorage.getItem('pwaInstalledFlag@sup')==='1'; }catch(_){ return false; } }
function markInstalled(){ try{ localStorage.setItem('pwaInstalledFlag@sup','1'); }catch(_){ } }
function updateInstallButtonsVisibility(){
  const btns=[...document.querySelectorAll('#btn-instalar')];
  const canPrompt=!!deferredPrompt;
  const installed=isMarkedInstalled()||isStandalone();
  const shouldShow=!installed && (canPrompt || isIOS());
  btns.forEach(b=> b.style.display=shouldShow?'':'none');
}
window.addEventListener('beforeinstallprompt',(e)=>{
  e.preventDefault(); deferredPrompt=e; updateInstallButtonsVisibility();
});
window.addEventListener('appinstalled',()=>{ markInstalled(); deferredPrompt=null; updateInstallButtonsVisibility(); });
document.querySelectorAll('#btn-instalar').forEach(btn=>{
  btn.addEventListener('click',async ()=>{
    playSoundOnce(SOUNDS.info);
    if(isIOS()){
      Swal.fire({icon:'info',title:'Instalar en iPhone/iPad',html:'1) Toca Compartir.<br>2) "Agregar a pantalla de inicio".<br>3) Confirmar.'});
      return;
    }
    if(!deferredPrompt){
      Swal.fire({icon:'info',title:'Instalaci√≥n no disponible todav√≠a'});
      return;
    }
    deferredPrompt.prompt();
    const choice=await deferredPrompt.userChoice;
    deferredPrompt=null;
    if(choice.outcome==='accepted'){
      markInstalled();
      Swal.fire({icon:'success',title:'¬°App instal√°ndose!',timer:8000,showConfirmButton:false});
    }
    updateInstallButtonsVisibility();
  });
});
async function initPWAVista(){
  if(isStandalone()||isMarkedInstalled()) showView('view-login');
  else{ showView('view-instalar'); updateInstallButtonsVisibility(); }
}
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>{
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  });
}
window.addEventListener('load',initPWAVista);

/* ================== FIN ================== */
</script>
</body>
</html>
