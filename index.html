<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>SUPERVISI√ìN</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="https://res.cloudinary.com/dqqeavica/image/upload/v1763928947/Logo_lt365u.png">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
  :root{
    --primary:#06402B;    /* verde institucional */
    --primary-2:#04281C;
    --ok:#16a34a;
    --error:#dc2626;
    --scrim:rgba(0,0,0,.35);
  }
  html,body{
    margin:0; padding:0; height:100%; width:100%;
    overflow-x:hidden;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    color:#111;
    background: url('https://res.cloudinary.com/dqqeavica/image/upload/v1746905870/fondo_verde_tvntsi.png') center/cover fixed no-repeat;
  }
  .container{ max-width: 1100px; margin: 0 auto; padding: 16px; }

  .view{ display:none; opacity:0; transform: translateY(8px);
    transition: opacity .25s ease, transform .25s ease;
    box-sizing:border-box; padding:16px;
  }
  .view.active{ display:block; opacity:1; transform: translateY(0); }

  .card{
    background: rgba(255,255,255,.06);
    backdrop-filter: blur(3px);
    border: 2px solid #ddd;
    border-radius: 16px;
    box-shadow: 0 8px 20px rgba(0,0,0,.18);
    max-width: 820px;
    margin: 16px auto;
    padding: 20px 20px 16px;
  }
  h1,h2,h3{ margin: 8px 0 12px; text-align:center; }
  p.helper{ color:#444; font-size:.95rem; text-align:center; margin:8px 0 16px; }
  label{ display:block; font-weight:700; margin: 10px 0 6px; color:var(--primary); }
  input, select, textarea, button{
    width:100%; padding:12px; box-sizing:border-box;
    border:1.5px solid #ccc; border-radius:8px; background:#fff;
    outline:none; transition: border-color .2s ease, transform .08s ease;
    font-size:16px;
  }
  input:focus, select:focus, textarea:focus{ border-color:var(--primary); }
  button{
    cursor:pointer; border:2px solid var(--primary);
    background:#fff; color:#000; font-weight:700;
  }
  button:hover{ background:var(--primary-2); color:#fff; border-color:var(--primary-2); }
  .btn-primary{ background:var(--primary); color:#fff; }
  .btn-row{ display:flex; gap:12px; flex-wrap:wrap; }
  .btn-row > *{ flex:1; }
  .muted{ color:#666; font-size:.85rem; }
  .center{ text-align:center; }
  .image-center{ display:flex; justify-content:center; }
  .brand{ width:240px; border-radius:12px; display:block; margin:12px auto 4px; }
  .banner-bottom{ width:240px; border-radius:12px; display:block; margin:16px auto 8px; }
  .chip{
    padding:8px 12px; border-radius:999px; border:2px solid var(--primary);
    background:#fff; font-weight:700; color:#000; text-decoration:none;
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
  }
  .danger{ background:#e11; border-color:#e11; color:#fff; }

 /* Botones de icono: sin recuadro ni fondo, con enfoque accesible */
.btn-icon{
  background: transparent !important;
  border: 0 !important;
  box-shadow: none !important;
  padding: 10px !important;
  display: flex;
  align-items: center;
  justify-content: center;
}
.btn-icon:hover,
.btn-icon:active{
  background: transparent !important;
  color: inherit !important;
  border: 0 !important;
}
.btn-icon:focus-visible{
  outline: none;
  box-shadow: 0 0 0 3px rgba(4,40,28,.28);
  border-radius: 10px;
}
.btn-icon img{
  width: 80px;
  height: 80px;
  display: block;
  border: 0;
  border-radius: 0;
  background: transparent;
  pointer-events: none;
}

/* Alinear √≠conos WhatsApp y Drive en UNA MISMA L√çNEA dentro de cada contratista */
.contr-actions{
  display:flex;
  flex-wrap:nowrap;
}
.contr-actions .left-group{
  display:flex;
  gap:12px;
  flex:1 1 auto;
}
.contr-actions .right-group{
  display:flex;
  align-items:center;
  justify-content:flex-end;
  gap:12px;
  margin-left:12px;
  flex:0 0 auto;
  min-width:auto;
}

/* Afinar √≠conos en el grupo derecho (tama√±o y efecto) */
.contr-actions .right-group .btn-icon{
  flex:0 0 auto;
  width:auto;
  display:inline-flex !important;
  align-items:center;
  justify-content:center;
  padding:6px !important;
  border:0 !important;
  background:transparent !important;
  box-shadow:none !important;
  cursor:pointer;
  transition:transform .12s ease;
}
.contr-actions .right-group .btn-icon:hover{ transform:scale(1.08); }
.contr-actions .right-group .btn-icon:active{ transform:scale(.94); }
.contr-actions .right-group .btn-icon img{
  width:44px !important;
  height:44px !important;
  display:block;
  object-fit:contain;
  pointer-events:none;
  filter:drop-shadow(0 2px 4px rgba(0,0,0,.25));
}

/* Responsive: en m√≥viles, √≠conos arriba y botones grandes abajo */
@media (max-width:700px){
  .contr-actions{
    flex-wrap: wrap !important;
    align-items: center;
  }
  .contr-actions .right-group{
    order: 1 !important;
    flex: 0 0 100% !important;
    justify-content: flex-end !important;
    margin-left: 0 !important;
    margin-top: 0 !important;
  }
  .contr-actions .left-group{
    order: 2 !important;
    flex: 0 0 100% !important;
    min-width: 0;
    margin-top: 8px;
    display: flex;
    gap: 12px;
  }
  .contr-actions .left-group > button{
    flex: 1 1 48%;
  }
}
/* Extra: si la pantalla es muy estrecha, apila los botones verticalmente */
@media (max-width:400px){
  .contr-actions .left-group > button{
    flex: 1 1 100%;
  }
}
  /* Loader centrado */
  .loader{
    position:fixed; inset:0;
    display:flex; align-items:center; justify-content:center;
    background:rgba(0,0,0,.35);
    z-index:9999; backdrop-filter: blur(2px);
    opacity:1; transition: opacity .12s ease;
  }
  .loader.hidden{
    opacity:0; pointer-events:none;
  }
  .spinner-ios{
    position:relative; width:64px; height:64px;
  }
  .spinner-ios i{
    position:absolute; left:50%; top:50%;
    width:6px; height:18px; margin:-9px 0 0 -3px;
    background:#fff; border-radius:3px;
    opacity:.2;
    animation:iosFade 1.2s linear infinite;
    transform-origin: center center;
  }
  @keyframes iosFade{
    0%, 39%, 100% { opacity:.2; }
    40% { opacity:1; }
  }
  .spinner-ios i:nth-child(1)  { transform: rotate(  0deg) translateY(-24px); animation-delay:-1.1s; }
  .spinner-ios i:nth-child(2)  { transform: rotate( 30deg) translateY(-24px); animation-delay:-1.0s; }
  .spinner-ios i:nth-child(3)  { transform: rotate( 60deg) translateY(-24px); animation-delay:-0.9s; }
  .spinner-ios i:nth-child(4)  { transform: rotate( 90deg) translateY(-24px); animation-delay:-0.8s; }
  .spinner-ios i:nth-child(5)  { transform: rotate(120deg) translateY(-24px); animation-delay:-0.7s; }
  .spinner-ios i:nth-child(6)  { transform: rotate(150deg) translateY(-24px); animation-delay:-0.6s; }
  .spinner-ios i:nth-child(7)  { transform: rotate(180deg) translateY(-24px); animation-delay:-0.5s; }
  .spinner-ios i:nth-child(8)  { transform: rotate(210deg) translateY(-24px); animation-delay:-0.4s; }
  .spinner-ios i:nth-child(9)  { transform: rotate(240deg) translateY(-24px); animation-delay:-0.3s; }
  .spinner-ios i:nth-child(10) { transform: rotate(270deg) translateY(-24px); animation-delay:-0.2s; }
  .spinner-ios i:nth-child(11) { transform: rotate(300deg) translateY(-24px); animation-delay:-0.1s; }
  .spinner-ios i:nth-child(12) { transform: rotate(330deg) translateY(-24px); animation-delay: 0s; }

  .hidden{ display:none !important; }
  .narrow{ max-width: 560px; margin: 0 auto; }
  .spaced{ margin-top:12px; }

  /* Listados */
  .list-grid{ display:flex; flex-direction:column; gap:14px; margin-top:14px; }
  .item-card{
    background: rgba(255,255,255,.06);
    backdrop-filter: blur(3px);
    border: 2px solid #ddd;
    border-radius:16px;
    padding:14px 16px;
    box-shadow:0 6px 14px rgba(0,0,0,.12);
    display:flex; flex-direction:column; gap:6px;
  }
  .item-header{
    display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:space-between;
  }
  .item-title{ font-weight:900; font-size:1rem; color:var(--primary); margin:0; }
  .item-sub{ font-size:.72rem; font-weight:700; color:#333; margin:0; }

  .estado-badge{
    display:inline-block; border-radius:999px; padding:6px 14px; font-weight:800;
    background:#c6f6d5; color:#06402B; border:2px solid #16a34a; font-size:.72rem;
  }
  .estado-badge.inactivo{ background:#fee2e2; color:#991b1b; border-color:#dc2626; }

  /* Secciones expandibles en Revisi√≥n */
  .section-toggle{ margin:12px 0; }
  .section-content{
    margin:8px 0 18px; background: rgba(255,255,255,.06);
    backdrop-filter: blur(3px); border:2px solid #ddd; border-radius:14px;
    padding:14px; box-shadow:0 6px 16px rgba(0,0,0,.12);
  }
  .section-content.hidden{ display:none; }

  .oblig-block{
    background:#f8f8f8; border:1.5px solid #ccc; border-radius:12px;
    padding:10px 12px; margin:10px 0; display:flex; flex-direction:column; gap:6px;
  }
  .oblig-title{ font-weight:800; margin:0; color:var(--primary); font-size:.9rem; }
  .oblig-sub{ margin:0; font-size:.75rem; color:#333; font-weight:600; }

  .evidence-grid{ display:flex; flex-wrap:wrap; gap:10px; justify-content:center; }
  .evidence-thumb{
    width:100%; max-width:320px; aspect-ratio:4/3; object-fit:cover;
    border-radius:10px; border:2px solid #ddd; background:#eee; cursor:zoom-in; display:block; margin:0 auto;
  }

  /* Overlay Men√∫ lateral (inspirado en referencia.md) */
  .overlay{ position: fixed; inset: 0; pointer-events:none; }
  .overlay .scrim{ position:absolute; inset:0; background:var(--scrim); opacity:0; transition:opacity .25s ease; }
  .overlay .panel{
    position:absolute; top:0; left:0; width:min(360px, 90vw); height:100%;
    background:#06402B; color:#fff; padding:16px 16px 8px 16px; box-sizing:border-box;
    transform: translateX(-100%); transition: transform .25s ease;
    display:flex; flex-direction:column; gap:10px; overflow-y:auto; min-height: 0;
  }
  .overlay.open{ pointer-events:auto; }
  .overlay.open .scrim{ opacity:1; }
  .overlay.open .panel{ transform: translateX(0); }
  .panel h3{ margin: 4px 0 8px; text-align:center; }
  .menu-btn{
    background:#7de3ef; color:#000; border:0; font-weight:800;
    border-radius:999px; padding:12px; box-shadow: 0 6px 12px rgba(0,0,0,.18);
  }

/* Avatar inicio: ajusta tama√±o aqu√≠ */
.avatar-emoji{
  width:120px;
  height:120px;
  display:block;
  margin:0 auto;           /* centra horizontalmente */
}
.avatar-img{
  width:160px;
  height:160px;
  border-radius:999px;
  border:2px solid #fff;
  object-fit:cover;
  display:block;
  margin:0 auto;           /* centra horizontalmente */
}

  /* Firma preview */
  .firma-preview{ max-width:260px; border-radius:12px; border:1.5px solid #d8e4ff; margin:8px auto 0; display:block; }

  @media (max-width: 700px){
    .btn-row{ flex-direction:column; }
  }

  /* Login: mostrar/ocultar c√©dula */
  .pwd-wrapper{ position:relative; width:100%; }
  .pwd-wrapper input#login-cedula{ display:block; width:100%; padding-right:40px; }
  .toggle-cedula{
    position:absolute; top:50%; right:10px; transform:translateY(-50%);
    background:transparent !important; border:0 !important; padding:0; width:28px; height:28px;
    display:flex; align-items:center; justify-content:center; cursor:pointer; border-radius:6px;
  }
  .toggle-cedula img{ width:22px; height:22px; display:block; }
  </style>
</head>
<body>
 <!-- Loader -->
<div id="loader" class="loader hidden" aria-live="polite" aria-busy="true">
  <div class="spinner-ios" role="status" aria-label="Cargando">
    <i></i><i></i><i></i><i></i><i></i><i></i>
    <i></i><i></i><i></i><i></i><i></i><i></i>
  </div>
</div>

  <div class="container">

    <!-- VISTA INSTALAR -->
    <section id="view-instalar" class="view">
      <div class="card narrow" style="text-align:center;">
        <h2 style="color:var(--primary);">APP SUPERVISI√ìN</h2>
        <img class="brand" alt="Instalar" src="https://res.cloudinary.com/dqqeavica/image/upload/v1763930524/menu_t9xli7.gif" />
        <p style="font-weight:600;">Herramienta de uso exclusivo para Supervisores de la Alcald√≠a de Flandes</p>
        <div class="btn-row" style="justify-content:center; margin-top:12px;">
          <button id="btn-instalar" class="btn-primary" style="display:none;">Instalar la App üì≤</button>
        </div>
        <p class="muted" style="margin-top:14px;">Si ya instalaste la App y no se inicia autom√°ticamente, refresca en unos segundos.</p>
      </div>
    </section>

    <!-- VISTA LOGIN -->
    <section id="view-login" class="view">
      <div class="card narrow">
        <h1 style="color:var(--primary); text-shadow: 0 2px 2px #031732;">SUPERVISI√ìN</h1>
        <p class="helper"><b>Acceso exclusivo para Supervisores autorizados.</b></p>

        <label>Contrase√±a</label>
        <div class="pwd-wrapper">
          <input id="login-cedula" type="password" inputmode="numeric" autocomplete="off" placeholder="Sin puntos ni espacios" />
          <button type="button" id="toggle-cedula" aria-label="Mostrar c√©dula" class="toggle-cedula">
            <img src="https://res.cloudinary.com/dqqeavica/image/upload/v1764084782/Mostrar_yymceh.png" alt="Mostrar">
          </button>
        </div>

        <div class="btn-row spaced">
          <button class="btn-primary" id="btn-login">Iniciar Sesi√≥n</button>
        </div>

        <img class="banner-bottom" alt="Banner" src="https://res.cloudinary.com/dqqeavica/image/upload/v1763921425/Digital_sw3wk9.gif" />
        <p class="center muted">Copyright ¬© <b>GOBIERNO DIGITAL</b></p>
      </div>
    </section>

    <!-- VISTA COMPLETA TU REGISTRO -->
    <section id="view-completar" class="view">
      <div class="card narrow">
        <h2 style="color:var(--primary)">COMPLETA TU REGISTRO</h2>
        <p class="helper">Sube tu firma (obligatoria) y tu imagen de perfil (opcional)</p>

        <label>Firma (obligatoria)</label>
        <p class="desc">Adjunta la imagen de tu firma</p>
        <input type="file" id="reg-firma" accept="image/*" />
        <img id="reg-firma-preview" src="" alt="Vista previa firma" style="display:none; max-width:100%; border-radius:10px; border:1.5px solid #d8e4ff; margin-top:8px;" />

        <label style="margin-top:12px;">Imagen de Perfil (opcional)</label>
        <p class="desc">Adjunta tu foto</p>
        <input type="file" id="reg-imagen" accept="image/*" />
        <img id="reg-imagen-preview" src="" alt="Vista previa imagen" style="display:none; max-width:100%; border-radius:10px; border:1.5px solid #d8e4ff; margin-top:8px;" />

        <div class="btn-row spaced">
          <button id="btn-reg-guardar" class="btn-primary">Guardar</button>
          <button id="btn-reg-volver" class="danger">Regresar</button>
        </div>
      </div>
    </section>

    <!-- VISTA INICIO -->
    <section id="view-inicio" class="view">
      <div class="card narrow">
        <div class="btn-row" style="margin-bottom:12px;">
          <button class="chip danger" id="btn-logout">Cerrar Sesi√≥n</button>
          <button class="chip" id="btn-open-menu">MEN√ö</button>
        </div>

        <div class="avatar-wrap">
  <img id="inicio-avatar-emoji" class="avatar-emoji" src="https://res.cloudinary.com/dqqeavica/image/upload/v1758738139/user_zefosv.png" alt="" style="display:none;" />
  <img id="inicio-avatar-img" class="avatar-img" src="" alt="" style="display:none;" />
</div>

        <h2 id="inicio-nombre" style="color:var(--primary); font-weight:900; margin-top:6px;"></h2>
<p id="inicio-rol" class="center muted" style="margin-top:0; font-weight:300;">SUPERVISOR(A)</p>

        <img id="inicio-firma" class="firma-preview" src="" alt="Firma" style="display:none;" />

        <img class="brand" alt="Banner" src="https://res.cloudinary.com/dqqeavica/image/upload/v1763921425/Digital_sw3wk9.gif" />
        <p class="center muted">Copyright ¬© <b>GOBIERNO DIGITAL</b></p>
      </div>
    </section>

    <!-- OVERLAY MEN√ö -->
    <div class="overlay" id="overlay">
      <div class="scrim" id="ovlClose"></div>
      <aside class="panel">
        <div class="btn-row">
          <button id="btn-ovl-back">ATR√ÅS</button>
        </div>
        <div class="image-center">
          <img alt="banner" src="https://res.cloudinary.com/dqqeavica/image/upload/v1763930524/menu_t9xli7.gif" style="max-width:180px;border-radius:10px;" />
        </div>
        <h3>Selecciona una opci√≥n</h3>
        <button class="menu-btn" id="go-contratistas">CONTRATISTAS</button>
        <button class="menu-btn" id="go-revision">REVISAR CUENTAS</button>
        <button class="menu-btn" id="go-planes-pagos">PLAN DE PAGOS</button>
        <button class="menu-btn" id="go-requerimientos">REQUERIMIENTO</button>
        <button class="menu-btn" id="go-comunicados">COMUNICADOS</button>
        <button class="menu-btn" id="go-actualizar">ACTUALIZAR FIRMA E IMAGEN</button>
        <button class="menu-btn" id="go-soporte">SOPORTE</button>
        <div style="height:24px"></div>
        <img class="brand" alt="Banner" src="https://res.cloudinary.com/dqqeavica/image/upload/v1763921425/Digital_sw3wk9.gif" />
        <p class="center muted">Copyright ¬© <b>GOBIERNO DIGITAL</b></p>
      </aside>
    </div>

    <!-- VISTA ACTUALIZAR -->
    <section id="view-actualizar" class="view">
      <div class="card narrow">
        <h2 style="color:var(--primary)">ACTUALIZAR PERFIL</h2>
        <p class="helper">Puedes actualizar tu firma e imagen de perfil (ambos opcionales)</p>

        <label>Firma (opcional)</label>
        <input type="file" id="upd-firma" accept="image/*" />
        <img id="upd-firma-preview" src="" alt="Vista previa firma" style="display:none; max-width:100%; border-radius:10px; border:1.5px solid #d8e4ff; margin-top:8px;" />

        <label style="margin-top:12px;">Imagen de Perfil (opcional)</label>
        <input type="file" id="upd-imagen" accept="image/*" />
        <img id="upd-imagen-preview" src="" alt="Vista previa imagen" style="display:none; max-width:100%; border-radius:10px; border:1.5px solid #d8e4ff; margin-top:8px;" />

        <div class="btn-row spaced">
          <button id="btn-upd-guardar" class="btn-primary">Guardar</button>
          <button id="btn-upd-volver" class="danger">Regresar</button>
        </div>
      </div>
    </section>

    <!-- VISTA CONTRATISTAS -->
    <section id="view-contratistas" class="view">
      <div class="card">
        <h2 style="color:var(--primary)">CONTRATISTAS</h2>

        <div class="center">
          <div id="contr-count" class="chip" style="display:none;">0</div>
          <p class="muted" style="margin:6px 0 12px;">N¬∞ de Contratistas</p>
        </div>

        <input id="contr-filter" class="chip" style="width:100%; border-radius:999px;" type="text" placeholder="Filtrar por nombre, documento, secretaria, supervisor o tel√©fono" aria-label="Filtrar contratistas">

        <div class="btn-row spaced">
          <button id="contr-volver" class="danger">REGRESAR</button>
        </div>

        <div id="contr-list" class="list-grid"></div>
      </div>
    </section>

    <!-- VISTA DETALLES CONTRATISTA -->
    <section id="view-detalles" class="view">
      <div class="card">
        <h2 style="color:var(--primary)">DETALLES DE CONTRATISTA</h2>
        <div id="detalles-body" class="narrow"></div>
        <div class="btn-row spaced">
          <button id="detalles-ocultar" class="danger">OCULTAR</button>
        </div>
      </div>
    </section>

    <!-- VISTA REVISI√ìN DE CUENTAS -->
    <section id="view-revision" class="view">
      <div class="card">
        <h2 style="color:var(--primary)">REVISI√ìN DE CUENTAS</h2>

        <div class="center">
          <div id="cuentas-count" class="chip" style="display:none;">0</div>
          <p class="muted" style="margin:6px 0 12px;">N¬∞ de Cuentas</p>
        </div>

        <input id="cuentas-filter" class="chip" style="width:100%; border-radius:999px;" type="text" placeholder="Filtrar por nombre, documento, informe o total informes">

        <div class="btn-row spaced">
          <button id="revision-volver" class="danger">REGRESAR</button>
        </div>

        <div id="cuentas-list" class="list-grid"></div>
      </div>
    </section>

    <!-- VISTA REVISAR CUENTA -->
    <section id="view-revisar-cuenta" class="view">
      <div class="card">
        <h2 id="rc-title" style="color:var(--primary)">REVISI√ìN DE CUENTA</h2>
        <div id="rc-body" class="narrow"></div>

        <div class="section-toggle">
          <button id="btn-toggle-contrato" class="chip">Ver Informaci√≥n del Contrato</button>
        </div>
        <div id="sec-contrato" class="section-content hidden"></div>

        <div class="section-toggle">
          <button id="btn-toggle-informe" class="chip">Ver Relaci√≥n de Informe y Pago</button>
        </div>
        <div id="sec-informe" class="section-content hidden"></div>

        <div class="section-toggle">
          <button id="btn-toggle-planilla" class="chip">Ver Relaci√≥n de Planilla</button>
        </div>
        <div id="sec-planilla" class="section-content hidden"></div>

        <div class="section-toggle">
          <button id="btn-toggle-planilla2" class="chip">Ver Relaci√≥n de Planilla Anexa</button>
        </div>
        <div id="sec-planilla2" class="section-content hidden"></div>

        <div class="section-toggle">
          <button id="btn-toggle-actividades" class="chip">Ver Relaci√≥n de Actividades</button>
        </div>

        <!-- Bot√≥n CUENTA debajo del bot√≥n de Actividades -->
<div class="center" style="margin-top:6px;">
  <button
    id="btn-abrir-carpeta-cuenta"
    class="btn-icon hidden"
    aria-label="Abrir carpeta de CUENTA en Drive"
    title="Abrir carpeta de CUENTA en Drive"
  >
    <img
      src="https://res.cloudinary.com/dqqeavica/image/upload/v1764111247/carpeta_drive_epbrhp.webp"
      alt="CUENTA"
    >
  </button>
</div>
        
        <div id="sec-actividades" class="section-content hidden">
          <div id="actividades-blocks"></div>
        </div>

        <h3 style="color:var(--primary); margin-top:18px;">TUS OBSERVACIONES</h3>
        <textarea id="rc-observaciones" rows="4" placeholder="Edita solo si vas a devolver la cuenta‚Ä¶"></textarea>

        <div class="btn-row spaced">
          <button id="rc-guardar" class="btn-primary">Guardar</button>
          <button id="rc-volver" class="danger">Regresar</button>
        </div>
      </div>
    </section>

        <!-- VISTA PLAN DE PAGO -->

    <section id="view-planes-pagos" class="view">
  <div class="card">
    <h2 style="color:var(--primary)">PLANES DE PAGOS REPORTADOS</h2>
    <div class="center">
      <div id="planes-count" class="chip" style="display:none;">0</div>
      <p class="muted" style="margin:6px 0 12px;">N¬∞ de Cuentas en Plan de Pagos</p>
    </div>
    <input id="planes-filter" class="chip" style="width:100%; border-radius:999px;" type="text" placeholder="Filtrar por nombre, documento, informe o total informes">
    <div class="btn-row spaced">
      <button id="planes-volver" class="danger">REGRESAR</button>
    </div>
    <div id="planes-list" class="list-grid"></div>
  </div>
</section>

    <!-- VISTA REQUERIMIENTO -->
    <section id="view-requerimientos" class="view">
      <div class="card">
        <h2 style="color:var(--primary)">REQUERIMIENTO</h2>
        <div class="center">
          <div id="req-count" class="chip" style="display:none;">0</div>
          <p class="muted" style="margin:6px 0 12px;">N¬∞ de Contratistas</p>
        </div>
        <input id="req-filter" class="chip" style="width:100%; border-radius:999px;" type="text" placeholder="Filtrar por nombre, documento, secretaria, supervisor o tel√©fono">
        <div id="req-list" class="list-grid"></div>
        <div class="btn-row spaced">
          <button id="req-volver" class="danger">REGRESAR</button>
        </div>
      </div>
    </section>

    <!-- MODAL REQUERIMIENTO -->
    <div id="modal-requerimiento" class="overlay hidden" style="position:fixed;">
      <div class="scrim" id="modal-close"></div>
      <aside class="panel" style="right:0; left:auto; transform:translateX(100%);">
        <div class="btn-row">
          <button id="modal-ovl-back">ATR√ÅS</button>
        </div>
        <h3 style="color:#fff">Redacta tu Requerimiento</h3>
        <textarea id="modal-req-text" rows="6" placeholder="Redacta el Requerimiento" style="border-radius:12px;"></textarea>
        <div class="btn-row" style="margin-top:14px;">
          <button id="modal-req-enviar" class="menu-btn">Enviar</button>
        </div>
      </aside>
    </div>

    <!-- VISTA COMUNICADOS -->
    <section id="view-comunicados" class="view">
      <div class="card narrow">
        <h2 style="color:var(--primary)">EMITE COMUNICADO</h2>
        <textarea id="comunicado-text" rows="6" placeholder="Escribe tu comunicado"></textarea>
        <div class="btn-row spaced">
          <button id="comunicado-enviar" class="btn-primary">Enviar</button>
          <button id="comunicado-volver" class="danger">Regresar</button>
        </div>
      </div>
    </section>

    <!-- VISTA SOPORTE -->
    <section id="view-soporte" class="view">
      <div class="card narrow">
        <h2 style="color:var(--primary)">¬øQU√â NECESITAS?</h2>
        <textarea id="soporte-text" rows="6" placeholder="Redacta detalladamente tu pregunta o sugerencia"></textarea>
        <div class="btn-row spaced">
          <button id="soporte-enviar" class="btn-primary">Enviar</button>
          <button id="soporte-volver" class="danger">Regresar</button>
        </div>
      </div>
    </section>

  </div>

<script>
/* ================== CONFIGURACI√ìN ================== */
const API_BASE = 'https://script.google.com/macros/s/AKfycbxODAokpEb3RRzeVlrriddyzbYxRwcLPh2ymehmBU_iM7zx4hLCWwcuHH5mV1qcIc0xAw/exec';
const BUILDERBOT_ENDPOINT = 'https://app.builderbot.cloud/api/v2/ff37a123-12b0-4fdc-9866-f3e2daf389fb/messages';
const BUILDERBOT_API_KEY  = 'bb-7f9ef630-5cfc-4ba4-9258-5e7cecbb4f65';

/* ================== SONIDOS ================== */
const SOUNDS = {
  question: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Pay_fail_ls2aif.mp3',
  info: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Default_notification_pkp4wr.mp3',
  success: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Pay_success_t5aawh.mp3',
  error: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Low_battery_d5qua1.mp3',
  warning: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Low_battery_d5qua1.mp3',
  login: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Siri_star_g1owy4.mp3',
  logout: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Siri_End_kelv02.mp3',
  back: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Keyboard_Enter_b9k2dc.mp3',
  menu: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Namedrop_Popup_ale2zy.mp3' // ‚Üê NUEVO
};
function playSoundOnce(url){
  try{
    const a = new Audio(url);
    a.preload = 'auto';
    a.play().catch(()=>{});
  }catch(e){}
}
if (window.Swal && typeof Swal.fire === 'function'){
  const __fire = Swal.fire.bind(Swal);
  Swal.fire = function(options = {}, ...rest){
    try{
      const icon = options.icon || options.type;
      if (icon && SOUNDS[icon]) playSoundOnce(SOUNDS[icon]);
    }catch(e){}
    return __fire(options, ...rest);
  }
}

/* ================== LOADER ================== */
const loader = document.getElementById('loader');
let loadingCount = 0;
let loaderTimer = null;
function startLoading(){
  loadingCount++;
  if (loadingCount === 1){
    loaderTimer = setTimeout(()=>{ loader.classList.remove('hidden'); loaderTimer = null; }, 120);
  }
}
function stopLoading(){
  if (loadingCount === 0) return;
  loadingCount--;
  if (loadingCount === 0){
    if (loaderTimer){ clearTimeout(loaderTimer); loaderTimer = null; }
    loader.classList.add('hidden');
  }
}

/* ================== API ================== */
async function apiGet(action, params = {}){
  startLoading();
  try{
    const url = new URL(API_BASE);
    url.search = new URLSearchParams({ action, ...params }).toString();
    const r = await fetch(url.toString(), { method: 'GET' });
    const j = await r.json();
    if(!j.ok) throw new Error(j.error || 'Error');
    return j.data;
  } finally { stopLoading(); }
}
async function apiPost(action, body = {}){
  startLoading();
  try{
    const url = API_BASE + '?action=' + encodeURIComponent(action);
    const r = await fetch(url, {
      method:'POST',
      headers: { 'Content-Type':'text/plain;charset=utf-8' },
      body: JSON.stringify(body)
    });
    const j = await r.json();
    if(!j.ok) throw new Error(j.error || 'Error');
    return j.data;
  } finally { stopLoading(); }
}

/* ================== BUILDERBOT ================== */
function normalizeNumber57(raw){
  let num = String(raw || '').replace(/\D/g,'');
  if(!num) return '';
  if(num.length === 10 && !num.startsWith('57')) num = '57' + num;
  if(!(num.length === 12 && num.startsWith('57'))) return '';
  return num;
}
function sendBuilderbotMessage(destino, mensaje){
  const numberField = String(destino || '').trim();
  if(!numberField){ console.warn('Destino vac√≠o'); return; }
  fetch(BUILDERBOT_ENDPOINT, {
    method:'POST',
    headers:{ 'Content-Type':'application/json', 'x-api-builderbot':BUILDERBOT_API_KEY },
    body: JSON.stringify({
      messages: { content: mensaje },
      number: numberField,
      checkIfExists: false
    })
  }).catch(err => console.warn('Error BuilderBot', err));
}

/* ================== ESTADO ================== */
let currentUser = null;  // { cedula, supervisor, firmaId, imagenId }
let supervisorNombreCompleto = ''; // Col C

/* ================== VISTAS ================== */
function showView(id){
  for(const el of document.querySelectorAll('.view')) el.classList.remove('active');
  const v = document.getElementById(id);
  if(v) v.classList.add('active');
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

/* ================== LOGIN ================== */
const loginCedula = document.getElementById('login-cedula');
document.getElementById('toggle-cedula').addEventListener('click', ()=>{
  const oculto = loginCedula.type === 'password';
  loginCedula.type = oculto ? 'text' : 'password';
  const nuevoIcono = oculto
    ? 'https://res.cloudinary.com/dqqeavica/image/upload/v1764084782/Ocultar_lgdxpd.png'
    : 'https://res.cloudinary.com/dqqeavica/image/upload/v1764084782/Mostrar_yymceh.png';
  const accion = oculto ? 'Ocultar' : 'Mostrar';
  document.getElementById('toggle-cedula').setAttribute('aria-label', accion + ' c√©dula');
  document.getElementById('toggle-cedula').innerHTML = '<img src="'+nuevoIcono+'" alt="'+accion+'">';
});
document.getElementById('btn-login').addEventListener('click', async ()=>{
  const cedula = (loginCedula.value||'').trim();
  if(!/^\d{6,10}$/.test(cedula)){
    Swal.fire({icon:'warning',title:'¬øDeseas Iniciar Sesi√≥n?',text:'Ingresa tu Contrase√±a'}); return;
  }
  try{
    const res = await apiGet('loginSupervisor', { cedula });
    if(!res || !res.encontrado){
      // Preparar datos para WhatsApp (se ejecutan solo si el usuario confirma)
      const soporte = '573103230712';
      const mensaje = 'Buen d√≠a *Oscar*%0A%0ANo tengo acceso a la app de Supervisi√≥n.%0A' +
        'Mi contrase√±a: *' + cedula + '*%0A' +
        'Te dejo mis datos a continuaci√≥n:%0A*Nombre Completo:*%0A*Celular:*';
      const esMovil = /android|iphone|ipad|mobile/i.test(navigator.userAgent);
      const urlWA = esMovil
        ? 'whatsapp://send?phone=' + soporte + '&text=' + mensaje
        : 'https://api.whatsapp.com/send?phone=' + soporte + '&text=' + mensaje;

      // Nueva alerta con dos opciones
      const rs = await Swal.fire({
        icon: 'error',
        title: 'NO TIENES ACCESO',
        text: 'Toma una de las opciones',
        showConfirmButton: true,
        confirmButtonText: 'Solicitar Acceso',
        showDenyButton: true,
        denyButtonText: 'Rectificar / Salir'
      });

      if (rs.isConfirmed){
        // Ejecuta la acci√≥n existente: abrir WhatsApp
        window.open(urlWA, '_blank');
        await Swal.fire({
          icon: 'success',
          title: 'Se abri√≥ WhatsApp',
          text: 'Solicita tu habilitaci√≥n por ese medio.',
          timer: 6000,
          showConfirmButton: false
        });
        return;
      } else if (rs.isDenied){
        // Borra el input y cierra
        loginCedula.value = '';
        return;
      }
    }
    
    // res: { encontrado, supervisor, firmaId, imagenId }
    currentUser = { cedula, supervisor: res.supervisor || '', firmaId: res.firmaId || '', imagenId: res.imagenId || '' };
    supervisorNombreCompleto = res.supervisor || '';
    if(!currentUser.firmaId){
      await Swal.fire({ icon:'success', title:`${supervisorNombreCompleto} completa tu registro`, text:'Solo debes ingresar la imagen de tu firma.' });
      showView('view-completar');
    }else{
      renderInicio();
      showView('view-inicio');
    }
  }catch(e){
    Swal.fire({icon:'error',title:'Error',text:e.message});
  }
});
document.getElementById('btn-logout').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.logout);
  currentUser = null; supervisorNombreCompleto = '';
  loginCedula.value = '';
  showView('view-login');
});

/* ================== INICIO ================== */
function driveThumbById(id){ return id ? ('https://drive.google.com/thumbnail?sz=w1000&id='+id) : ''; }
function renderInicio(){
  // Avatar
  const imgEl   = document.getElementById('inicio-avatar-img');
  const emojiEl = document.getElementById('inicio-avatar-emoji');
  const hasImagen = !!currentUser?.imagenId;

  // prepara handlers antes de asignar src
  imgEl.onload = () => { imgEl.style.display=''; emojiEl.style.display='none'; };
  imgEl.onerror = () => { imgEl.style.display='none'; emojiEl.style.display=''; };

  if(hasImagen){
    imgEl.style.display='none';           // oculto hasta que cargue
    emojiEl.style.display='none';         // oculto mientras intenta
    imgEl.src = driveThumbById(currentUser.imagenId);
  }else{
    imgEl.style.display='none';
    emojiEl.style.display='';
  }

  // Nombre y rol
  document.getElementById('inicio-nombre').textContent = supervisorNombreCompleto;
  const rolEl = document.getElementById('inicio-rol');
  if(rolEl) rolEl.textContent = 'SUPERVISOR(A)';

  // Firma (igual que antes)
  const firmaEl = document.getElementById('inicio-firma');
  const hasFirma = !!currentUser?.firmaId;
  if(hasFirma){
    firmaEl.src = driveThumbById(currentUser.firmaId);
    firmaEl.style.display='';
  }else{
    firmaEl.style.display='none';
  }
}

/* ================== OVERLAY MEN√ö ================== */
const overlay = document.getElementById('overlay');

// Bot√≥n MEN√ö: sonido 'menu' + abrir
document.getElementById('btn-open-menu').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.menu);
  overlay.classList.add('open');
});

// Bot√≥n ATR√ÅS dentro del panel: sonido 'back' + cerrar
document.getElementById('btn-ovl-back').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  overlay.classList.remove('open');
});

// Clic en el scrim (fondo oscuro): sonido 'back' + cerrar
document.getElementById('ovlClose').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  overlay.classList.remove('open');
});


/* Sonido 'logout' al seleccionar cualquiera de las opciones del overlay.
   Ubicar este bucle inmediatamente despu√©s de los listeners anteriores. */
['go-actualizar','go-contratistas','go-revision','go-planes-pagos','go-requerimientos','go-comunicados','go-soporte']
  .forEach(id => {
    const el = document.getElementById(id);
    if(el){
      el.addEventListener('click', ()=>{
        playSoundOnce(SOUNDS.logout);
        // El overlay se cierra en cada acci√≥n (si a√∫n no lo cierras en otro lugar)
        overlay.classList.remove('open');
      });
    }
  });

/* ================== COMPLETAR REGISTRO ================== */
// Previsualizaci√≥n simple (si compresi√≥n falla, usa original)
let regFirmaDataUrl = ''; let regImagenDataUrl = '';
document.getElementById('reg-firma').addEventListener('change', async (e)=>{
  const file = e.target.files && e.target.files[0];
  const prev = document.getElementById('reg-firma-preview');
  if(!file){ regFirmaDataUrl=''; prev.style.display='none'; prev.src=''; return; }
  try{
    const reader = new FileReader();
    reader.onload = ev => { regFirmaDataUrl = ev.target.result; prev.src = regFirmaDataUrl; prev.style.display='block'; };
    reader.readAsDataURL(file);
  }catch(_){
    regFirmaDataUrl=''; prev.style.display='none';
  }
});
document.getElementById('reg-imagen').addEventListener('change', async (e)=>{
  const file = e.target.files && e.target.files[0];
  const prev = document.getElementById('reg-imagen-preview');
  if(!file){ regImagenDataUrl=''; prev.style.display='none'; prev.src=''; return; }
  try{
    const reader = new FileReader();
    reader.onload = ev => { regImagenDataUrl = ev.target.result; prev.src = regImagenDataUrl; prev.style.display='block'; };
    reader.readAsDataURL(file);
  }catch(_){
    regImagenDataUrl=''; prev.style.display='none';
  }
});
document.getElementById('btn-reg-guardar').addEventListener('click', async ()=>{
  if(!currentUser){ Swal.fire({icon:'warning',title:'Sesi√≥n inv√°lida'}); return; }
  if(!regFirmaDataUrl){ Swal.fire({icon:'warning',title:'Firma requerida'}); return; }
  try{
    const r = await apiPost('completarRegistroSupervisor', {
      cedula: currentUser.cedula,
      firmaDataUrl: regFirmaDataUrl,
      imagenDataUrl: regImagenDataUrl || ''
    });
    currentUser.firmaId = r?.firmaId || currentUser.firmaId;
    currentUser.imagenId = r?.imagenId || currentUser.imagenId;
    Swal.fire({icon:'success',title:'Registro completado',timer:1800,showConfirmButton:false});
    renderInicio(); showView('view-inicio');
  }catch(e){
    Swal.fire({icon:'error',title:'Error',text:e.message});
  }
});
document.getElementById('btn-reg-volver').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  showView('view-login');
});

/* ================== ACTUALIZAR ================== */
let updFirmaDataUrl=''; let updImagenDataUrl='';
document.getElementById('upd-firma').addEventListener('change', async (e)=>{
  const file = e.target.files && e.target.files[0];
  const prev = document.getElementById('upd-firma-preview');
  if(!file){ updFirmaDataUrl=''; prev.style.display='none'; prev.src=''; return; }
  try{
    const reader = new FileReader();
    reader.onload = ev => { updFirmaDataUrl = ev.target.result; prev.src = updFirmaDataUrl; prev.style.display='block'; };
    reader.readAsDataURL(file);
  }catch(_){ updFirmaDataUrl=''; prev.style.display='none'; }
});
document.getElementById('upd-imagen').addEventListener('change', async (e)=>{
  const file = e.target.files && e.target.files[0];
  const prev = document.getElementById('upd-imagen-preview');
  if(!file){ updImagenDataUrl=''; prev.style.display='none'; prev.src=''; return; }
  try{
    const reader = new FileReader();
    reader.onload = ev => { updImagenDataUrl = ev.target.result; prev.src = updImagenDataUrl; prev.style.display='block'; };
    reader.readAsDataURL(file);
  }catch(_){ updImagenDataUrl=''; prev.style.display='none'; }
});
document.getElementById('go-actualizar').addEventListener('click', ()=>{ overlay.classList.remove('open'); showView('view-actualizar'); });
document.getElementById('btn-upd-volver').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  showView('view-inicio');
});
document.getElementById('btn-upd-guardar').addEventListener('click', async ()=>{
  if(!currentUser){ Swal.fire({icon:'warning',title:'Sesi√≥n inv√°lida'}); return; }
  if(!updFirmaDataUrl && !updImagenDataUrl){ Swal.fire({icon:'info',title:'Sin cambios'}); return; }
  try{
    const r = await apiPost('actualizarPerfilSupervisor', {
      cedula: currentUser.cedula,
      firmaDataUrl: updFirmaDataUrl || '',
      imagenDataUrl: updImagenDataUrl || ''
    });
    if(r?.firmaId) currentUser.firmaId = r.firmaId;
    if(r?.imagenId) currentUser.imagenId = r.imagenId;
    Swal.fire({icon:'success',title:'Perfil actualizado',timer:1800,showConfirmButton:false});
    renderInicio(); showView('view-inicio');
  }catch(e){
    Swal.fire({icon:'error',title:'Error',text:e.message});
  }
});

/* ================== CONTRATISTAS ================== */
let CONTR_DATA=[];
document.getElementById('go-contratistas').addEventListener('click', async ()=>{
  overlay.classList.remove('open');
  await cargarContratistas();
  showView('view-contratistas');
});
async function cargarContratistas(){
  try{
    const list=await apiGet('listContratistasSupervisor', { supervisor: supervisorNombreCompleto });
    CONTR_DATA=Array.isArray(list)?list:[];
    pintarContratistas(CONTR_DATA);
    actualizarResumenContratistas(CONTR_DATA);
  }catch(e){
    CONTR_DATA=[]; pintarContratistas(CONTR_DATA); actualizarResumenContratistas(CONTR_DATA);
    Swal.fire({icon:'error',title:'Error',text:e.message});
  }
}
function actualizarResumenContratistas(list){
  const box=document.getElementById('contr-count');
  if(!list.length){ box.style.display='none'; box.textContent=''; return; }
  box.textContent=String(list.length);
  box.style.display='inline-block';
}
function pintarContratistas(list){
  const wrap=document.getElementById('contr-list');
  wrap.innerHTML='';
  if(!list.length){ wrap.innerHTML='<p class="muted center">No hay contratistas.</p>'; return; }
  for(const c of list){
    const div=document.createElement('div'); div.className='item-card';
    const header=document.createElement('div'); header.className='item-header';
    const title=document.createElement('p'); title.className='item-title'; title.textContent=(c.nombre||'');
    header.appendChild(title);
    // Estado (solo visual)
    const estadoSpan = document.createElement('span');
    estadoSpan.className = 'estado-badge ' + (c.estado === 'ACTIVO' ? '' : 'inactivo');
    estadoSpan.textContent = c.estado || '';
    header.appendChild(estadoSpan);
    div.appendChild(header);

    const pDoc=document.createElement('p'); pDoc.className='item-sub'; pDoc.textContent='CC: '+(c.documento||''); div.appendChild(pDoc);
    const pSec=document.createElement('p'); pSec.className='item-sub'; pSec.textContent='SECRETAR√çA: '+(c.secretaria||''); div.appendChild(pSec);
    const pSup=document.createElement('p'); pSup.className='item-sub'; pSup.innerHTML='SUPERVISOR: '+(c.supervisor||'') + (c.matchSupervisor ? ' <b>(ASIGNADO A TI)</b>' : '');
    div.appendChild(pSup);

    const actionsRow = document.createElement('div');
    actionsRow.className = 'contr-actions';

    const leftGroup = document.createElement('div');
    leftGroup.className = 'left-group';

    const rightGroup = document.createElement('div');
    rightGroup.className = 'right-group';

    // Bot√≥n grande: Mostrar detalles (queda en el grupo izquierdo)
    const btnDetalles = document.createElement('button');
    btnDetalles.textContent = 'MOSTRAR DETALLES';
    btnDetalles.addEventListener('click', ()=> {
      playSoundOnce(SOUNDS.logout);
      mostrarDetallesContratista(c.documento);
    });
    leftGroup.appendChild(btnDetalles);

    // √çcono WhatsApp (grupo derecho)
    const btnWhatsapp = document.createElement('button');
    btnWhatsapp.className = 'btn-icon';
    btnWhatsapp.innerHTML = '<img src="https://res.cloudinary.com/dqqeavica/image/upload/v1759166341/WhatsApp_mljaqm.webp" alt="WhatsApp">';
    btnWhatsapp.setAttribute('aria-label','Abrir chat de WhatsApp');
    btnWhatsapp.addEventListener('click', ()=>{
      let tel=String(c.telefono||'').replace(/\D/g,'');
      if(!tel){ Swal.fire({icon:'info',title:'Sin tel√©fono'}); return; }
      if(!tel.startsWith('57')) tel='57'+tel;
      if(!/^57\d{10}$/.test(tel)){ Swal.fire({icon:'warning',title:'Tel√©fono inv√°lido'}); return; }
      window.open('https://wa.me/'+tel,'_blank');
    });

    // √çcono Drive (grupo derecho)
    const btnDrive = document.createElement('button');
    btnDrive.className = 'btn-icon';
    btnDrive.innerHTML = '<img src="https://res.cloudinary.com/dqqeavica/image/upload/v1763997280/DRIVE_bycgsc.webp" alt="Drive">';
    btnDrive.setAttribute('aria-label','Abrir carpeta Drive');
    btnDrive.addEventListener('click', ()=>{
      if(c.carpetaContratista){
        window.open('https://drive.google.com/drive/folders/'+c.carpetaContratista,'_blank');
      } else {
        Swal.fire({icon:'info',title:'Sin carpeta'});
      }
    });

    rightGroup.appendChild(btnWhatsapp);
    rightGroup.appendChild(btnDrive);

    actionsRow.appendChild(leftGroup);
    actionsRow.appendChild(rightGroup);
    div.appendChild(actionsRow);
    wrap.appendChild(div);
  }
}
document.getElementById('contr-filter').addEventListener('input',()=>{
  const q=document.getElementById('contr-filter').value.trim().toLowerCase();
  const filtered=CONTR_DATA.filter(c=>{
    return [c.nombre,c.documento,c.secretaria,c.supervisor,c.telefono].some(v=>String(v||'').toLowerCase().includes(q));
  });
  pintarContratistas(filtered); actualizarResumenContratistas(filtered);
});
document.getElementById('contr-volver').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  showView('view-inicio');
});

/* ================== DETALLES ================== */
async function mostrarDetallesContratista(documento){
  try{
    const d=await apiGet('detallesContratistaSupervisor',{documento});
    const body=document.getElementById('detalles-body');
    body.innerHTML='';
    if(!d){ body.innerHTML='<p class="muted center">No encontrado.</p>'; }
    else {
      const lines=[
        `<b>NOMBRE:</b> ${d.nombre||''}`,
        `<b>CC:</b> ${d.documento||''} <b>de:</b> ${d.expedida||''}`,
        `<b>TELEFONO:</b> ${d.telefono||'SIN REGISTRO'}`,
        `<b>CORREO:</b> ${d.correo||'SIN REGISTRO'}`,
        `<b>CUENTA:</b> ${d.cuenta||''} ${d.tipoCuenta||''} ${d.banco||''}`,
        `<b>EPS:</b> ${d.eps||''}`,
        `<b>AFP:</b> ${d.pension||''}`,
        `<b>ARL:</b> ${d.arl||''}`,
        `<b>SECRETAR√çA:</b> ${d.secretaria||''}`,
        `<b>SUPERVISOR:</b> ${d.supervisor||''}`,
        `<b>CONTRATO:</b> ${d.contrato||''} <b>de:</b> ${d.fechaContrato||''}`,
        `<b>OBJETO:</b> ${d.objeto||''}`,
        `<b>FECHA DE INICIO:</b> ${d.fechaInicio||''}`,
        `<b>FECHA DE TERMINO:</b> ${d.fechaTermino||''}`,
        `<b>VALOR INICIAL:</b> ${d.valor||''}`,
        `<b>MRA:</b> ${d.mra||''}`,
        `<b>VALOR FINAL:</b> ${d.valorFinal||''}`,
        `<b>CDP:</b> ${d.cdp||''}`,
        `<b>RP:</b> ${d.rp||''}`,
        `<b>CDP ADICI√ìN:</b> ${d.cdpAdicion||''}`,
        `<b>RP ADICI√ìN:</b> ${d.rpAdicion||''}`,
        `<b>REGIMEN:</b> ${d.regimen||''}`
      ];
      for(let i=1;i<=26;i++){
        const val=d['obligacion'+i];
        if(val && val!=='-'){ lines.push(`<b>OBLIGACI√ìN ${i}:</b> ${val}`); }
      }
      body.innerHTML=lines.map(l=>`<p>${l}</p>`).join('');
    }
    showView('view-detalles');
  }catch(e){ Swal.fire({icon:'error',title:'Error',text:e.message}); }
}
document.getElementById('detalles-ocultar').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  showView('view-contratistas');
});

/* ================== REVISI√ìN ================== */
let CUENTAS_DATA=[];
document.getElementById('go-revision').addEventListener('click', async ()=>{
  overlay.classList.remove('open');
  await cargarCuentas();
  showView('view-revision');
});
async function cargarCuentas(){
  try{
    const list=await apiGet('listCuentasIngresadas',{ supervisor: supervisorNombreCompleto });
    CUENTAS_DATA=Array.isArray(list)?list:[];
    pintarCuentas(CUENTAS_DATA);
    actualizarResumenCuentas(CUENTAS_DATA);
  }catch(e){
    CUENTAS_DATA=[]; pintarCuentas(CUENTAS_DATA); actualizarResumenCuentas(CUENTAS_DATA);
    Swal.fire({icon:'error',title:'Error',text:e.message});
  }
}
function actualizarResumenCuentas(list){
  const box=document.getElementById('cuentas-count');
  if(!list.length){ box.style.display='none'; box.textContent=''; return; }
  box.textContent=String(list.length); box.style.display='inline-block';
}
function pintarCuentas(list){
  const wrap=document.getElementById('cuentas-list');
  wrap.innerHTML='';
  if(!list.length){ wrap.innerHTML='<p class="muted center">No hay cuentas.</p>'; return; }

  for(const c of list){
    const div=document.createElement('div'); div.className='item-card';

    const header=document.createElement('div'); header.className='item-header';
    const title=document.createElement('p'); title.className='item-title'; title.textContent=(c.nombre||''); header.appendChild(title);
    div.appendChild(header);

    const pDoc=document.createElement('p'); pDoc.className='item-sub'; pDoc.textContent='CC: '+(c.documento||''); div.appendChild(pDoc);
    const pInf=document.createElement('p'); pInf.className='item-sub'; pInf.textContent='INFORME: '+(c.informe||'')+' de: '+(c.totalInformes||''); div.appendChild(pInf);

    const btnRow=document.createElement('div'); btnRow.className='btn-row';

    // Bot√≥n REVISAR (como lo tienes)
    const btnRevisar=document.createElement('button'); btnRevisar.textContent='REVISAR';
    btnRevisar.addEventListener('click', ()=> {
      playSoundOnce(SOUNDS.logout);
      abrirRevisionCuenta(c.documento);
    });
    btnRow.appendChild(btnRevisar);

    div.appendChild(btnRow);
    wrap.appendChild(div);
  }
}
document.getElementById('cuentas-filter').addEventListener('input',()=>{
  const q=document.getElementById('cuentas-filter').value.trim().toLowerCase();
  const filtered=CUENTAS_DATA.filter(c=>{
    return [c.nombre,c.documento,c.informe,c.totalInformes].some(v=>String(v||'').toLowerCase().includes(q));
  });
  pintarCuentas(filtered); actualizarResumenCuentas(filtered);
});
document.getElementById('revision-volver').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  showView('view-inicio');
});



function resetToggleSections(){
  const defs = [
    ['btn-toggle-contrato','sec-contrato','Ver Informaci√≥n del Contrato','Ocultar Informaci√≥n del Contrato'],
    ['btn-toggle-informe','sec-informe','Ver Relaci√≥n de Informe y Pago','Ocultar Relaci√≥n de Informe y Pago'],
    ['btn-toggle-planilla','sec-planilla','Ver Relaci√≥n de Planilla','Ocultar Relaci√≥n de Planilla'],
    ['btn-toggle-planilla2','sec-planilla2','Ver Relaci√≥n de Planilla Anexa','Ocultar Relaci√≥n de Planilla Anexa'],
    ['btn-toggle-actividades','sec-actividades','Ver Relaci√≥n de Actividades','Ocultar Relaci√≥n de Actividades']
  ];
  defs.forEach(([btnId,secId,showTxt,hideTxt])=>{
    const sec=document.getElementById(secId); const btn=document.getElementById(btnId);
    if(sec) sec.classList.add('hidden'); if(btn) btn.textContent=showTxt;
  });
}
(function bindToggles(){
  const defs = [
    ['btn-toggle-contrato','sec-contrato','Ver Informaci√≥n del Contrato','Ocultar Informaci√≥n del Contrato'],
    ['btn-toggle-informe','sec-informe','Ver Relaci√≥n de Informe y Pago','Ocultar Relaci√≥n de Informe y Pago'],
    ['btn-toggle-planilla','sec-planilla','Ver Relaci√≥n de Planilla','Ocultar Relaci√≥n de Planilla'],
    ['btn-toggle-planilla2','sec-planilla2','Ver Relaci√≥n de Planilla Anexa','Ocultar Relaci√≥n de Planilla Anexa'],
    ['btn-toggle-actividades','sec-actividades','Ver Relaci√≥n de Actividades','Ocultar Relaci√≥n de Actividades']
  ];
  defs.forEach(([btnId,secId,showTxt,hideTxt])=>{
    const sec=document.getElementById(secId); const btn=document.getElementById(btnId);
    if(!btn || !sec) return; if(btn.dataset.bound) return; btn.dataset.bound='1';
    btn.addEventListener('click',()=>{
      const visible=!sec.classList.contains('hidden');
      if(visible){ sec.classList.add('hidden'); btn.textContent=showTxt; }
      else{ sec.classList.remove('hidden'); btn.textContent=hideTxt; }
    });
  });
})();

let REV_CUENTA=null;
async function abrirRevisionCuenta(documento){
  try{
    const data=await apiGet('revisarCuentaDataSupervisor',{documento});
    if(!data){ Swal.fire({icon:'info',title:'No encontrado'}); return; }
    REV_CUENTA=data;
    resetToggleSections();
    renderRevisionCuenta();
    showView('view-revisar-cuenta');
  }catch(e){ Swal.fire({icon:'error',title:'Error',text:e.message}); }
}
function formatInfoList(arr){ return arr.map(x=>`<p>${x}</p>`).join(''); }
function renderRevisionCuenta(){
  const c=REV_CUENTA?.contratista; const cu=REV_CUENTA?.cuenta;
  document.getElementById('rc-title').textContent='REVISI√ìN DE CUENTA N¬∞ '+(cu?.informe||'')+' de '+(c?.nombre||'');
  const rcBody=document.getElementById('rc-body');
  rcBody.innerHTML = formatInfoList([ `<b>DOCUMENTO:</b> ${c?.documento||''}`, `<b>SECRETAR√çA:</b> ${c?.secretaria||''}`, `<b>SUPERVISOR:</b> ${c?.supervisor||''}` ]);

  document.getElementById('sec-contrato').innerHTML = formatInfoList([
    `<b>CONTRATO N¬∞:</b> ${c?.contrato||''}`,
    `<b>FECHA DE CONTRATO:</b> ${c?.fechaContrato||''}`,
    `<b>FECHA DE INICIO:</b> ${c?.fechaInicio||''}`,
    `<b>FECHA DE TERMINO:</b> ${c?.fechaTermino||''}`,
    `<b>VALOR INICIAL:</b> ${c?.valor || '-'}`,
    `<b>MRA:</b> ${c?.mra||''}`,
    `<b>VALOR FINAL:</b> ${c?.valorFinal||''}`,
    `<b>CDP:</b> ${c?.cdp||''}`,
    `<b>RP:</b> ${c?.rp||''}`,
    `<b>CDP ADICI√ìN:</b> ${c?.cdpAdicion||''}`,
    `<b>RP ADICI√ìN:</b> ${c?.rpAdicion||''}`,
    `<b>SECRETAR√çA:</b> ${c?.secretaria||''}`,
    `<b>SUPERVISOR:</b> ${c?.supervisor||''}`,
  ]);

  document.getElementById('sec-informe').innerHTML = [
    `<h4 style="margin:4px 0;color:var(--primary)">RELACI√ìN DE INFORME</h4>`,
    `<p><b>FECHA DE RADICACI√ìN:</b> ${cu?.fechaRadicacion||''}</p>`,
    `<p><b>INFORME:</b> ${cu?.informe||''} de ${cu?.totalInformes||''}</p>`,
    `<p><b>INICIO DE PERIODO RATIFICADO:</b> ${cu?.inicioRatificar||''}</p>`,
    `<p><b>FIN DE PERIODO RATIFICADO:</b> ${cu?.finRatificar||''}</p>`,
    `<h4 style="margin:14px 0 4px;color:var(--primary)">RELACI√ìN DE PAGO</h4>`,
    `<p><b>SALDO ACTUAL:</b> ${cu?.saldoActual||''}</p>`,
    `<p><b>VALOR COBRADO:</b> ${cu?.menos||''}</p>`,
    `<p><b>NUEVO SALDO:</b> ${cu?.nuevoSaldo||''}</p>`
  ].join('');

  document.getElementById('sec-planilla').innerHTML = [
    `<h4 style="margin:4px 0;color:var(--primary)">RELACI√ìN DE PLANILLA</h4>`,
    `<p><b>PLANILLA N¬∞:</b> ${cu?.planilla||''} de ${cu?.mesPlanilla||''}</p>`,
    `<p><b>BASE DE COTIZACI√ìN:</b> ${cu?.base||''}</p>`,
    `<p><b>APORTES A SALUD:</b> ${cu?.salud||''}</p>`,
    `<p><b>APORTES A PENSI√ìN:</b> ${cu?.fondo||''}</p>`,
    `<p><b>APORTES A ARL:</b> ${cu?.riesgos||''}</p>`,
    `<p><b>APORTES FPS:</b> ${cu?.solidario||''} ${cu?.aporte||''}</p>`
  ].join('');

  document.getElementById('sec-planilla2').innerHTML = [
    `<h4 style="margin:4px 0;color:var(--primary)">RELACI√ìN DE PLANILLA ANEXA</h4>`,
    `<p><b>PLANILLA ANEXA N¬∞:</b> ${cu?.planilla2||''} de ${cu?.mesPlanilla2||''}</p>`,
    `<p><b>BASE DE COTIZACI√ìN:</b> ${cu?.base2||''}</p>`,
    `<p><b>APORTES A SALUD:</b> ${cu?.salud2||''}</p>`,
    `<p><b>APORTES A PENSI√ìN:</b> ${cu?.fondo2||''}</p>`,
    `<p><b>APORTES A ARL:</b> ${cu?.riesgos2||''}</p>`,
    `<p><b>APORTES FPS:</b> ${cu?.solidario2||''} ${cu?.aporte2||''}</p>`
  ].join('');

  const blocksWrap=document.getElementById('actividades-blocks');
  blocksWrap.innerHTML='';
  const actividades=REV_CUENTA?.actividades||[];
  const evidencias=REV_CUENTA?.evidencias||[];
  const obligaciones=REV_CUENTA?.obligaciones||[];
  const total=obligaciones.length;
  function extraerDriveId(url){
    if(!url) return '';
    const primera=String(url).trim().split(/\s+/)[0];
    const patrones=[ /\/d\/([A-Za-z0-9_-]{10,})/, /id=([A-Za-z0-9_-]{10,})/, /\/file\/d\/([A-Za-z0-9_-]{10,})/, /open\?[^#]*id=([A-Za-z0-9_-]{10,})/ ];
    for(const rx of patrones){ const m=primera.match(rx); if(m) return m[1]; }
    return '';
  }
  function evidenciaThumb(url){ const id=extraerDriveId(url); return id ? 'https://drive.google.com/thumbnail?sz=w1000&id='+id : url; }
  function evidenciaFull(url){
    if(!url) return '';
    const primera=String(url).trim().split(/\s+/)[0];
    const patrones=[ /\/d\/([A-Za-z0-9_-]{10,})/, /id=([A-Za-z0-9_-]{10,})/, /\/file\/d\/([A-Za-z0-9_-]{10,})/, /open\?[^#]*id=([A-Za-z0-9_-]{10,})/ ];
    let id=''; for(const rx of patrones){ const m=primera.match(rx); if(m){ id=m[1]; break; } }
    return id ? 'https://drive.google.com/uc?export=view&id='+id : primera;
  }
  function abrirZoomEvidencia(src, titulo){
    const overlay = document.createElement('div'); overlay.style.position='fixed'; overlay.style.inset='0'; overlay.style.background='rgba(0,0,0,.75)';
    overlay.style.zIndex='10000'; overlay.style.display='flex'; overlay.style.alignItems='center'; overlay.style.justifyContent='center'; overlay.style.padding='24px';
    const box=document.createElement('div'); box.style.maxWidth='90%'; box.style.maxHeight='90%'; box.style.position='relative'; box.style.background='#fff'; box.style.borderRadius='14px';
    box.style.padding='12px'; box.style.boxShadow='0 8px 24px rgba(0,0,0,.4)'; box.style.display='flex'; box.style.flexDirection='column'; box.style.alignItems='center'; box.style.gap='12px';
    const titleEl=document.createElement('h3'); titleEl.textContent=titulo; titleEl.style.margin='0'; titleEl.style.color='var(--primary)';
    const img=document.createElement('img'); img.style.maxWidth='100%'; img.style.maxHeight='70vh'; img.style.borderRadius='10px'; img.style.objectFit='contain'; img.alt=titulo;
    const loaderMsg=document.createElement('p'); loaderMsg.textContent='Cargando imagen‚Ä¶'; loaderMsg.style.margin='0'; loaderMsg.style.fontSize='.85rem'; loaderMsg.style.color='#333';
    img.addEventListener('error', ()=>{
      if(src.includes('uc?export=view&id=')){
        const idMatch = src.match(/id=([A-Za-z0-9_-]{10,})/);
        if(idMatch){ img.src='https://drive.google.com/thumbnail?sz=w1000&id='+idMatch[1]; loaderMsg.textContent='(Vista alternativa)'; }
      } else { loaderMsg.textContent='No se pudo cargar la evidencia.'; }
    });
    img.addEventListener('load', ()=> loaderMsg.textContent='');
    img.src=src;
    const cerrarBtn=document.createElement('button'); cerrarBtn.textContent='Cerrar'; cerrarBtn.className='btn-primary'; cerrarBtn.style.maxWidth='160px';
    cerrarBtn.addEventListener('click', ()=> document.body.removeChild(overlay));
    overlay.addEventListener('click', (e)=>{ if(e.target===overlay) document.body.removeChild(overlay); });
    box.appendChild(titleEl); box.appendChild(img); box.appendChild(loaderMsg); box.appendChild(cerrarBtn); overlay.appendChild(box); document.body.appendChild(overlay);
  }
  for(let i=1;i<=total;i++){
    const oblig=obligaciones[i-1]; const act=actividades[i-1]; const evid=evidencias[i-1];
    if(![oblig,act,evid].some(v=>v && v!=='-')) continue;
    const block=document.createElement('div'); block.className='oblig-block';
    const titulo=document.createElement('p'); titulo.className='oblig-title'; titulo.textContent='OBLIGACI√ìN N¬∞ '+i; block.appendChild(titulo);
    if(oblig && oblig!=='-'){ const ob=document.createElement('p'); ob.className='oblig-sub'; ob.textContent=oblig; block.appendChild(ob); }
    if(act && act!=='-'){ const ac=document.createElement('p'); ac.className='oblig-sub'; ac.innerHTML='<b>Actividades:</b> '+act; block.appendChild(ac); }
    if(evid && evid!=='-'){
      const evDiv=document.createElement('div'); evDiv.className='evidence-grid';
      const img=document.createElement('img'); img.className='evidence-thumb'; img.src=evidenciaThumb(evid); img.alt='Evidencia '+i;
      img.addEventListener('click', ()=> abrirZoomEvidencia(evidenciaFull(evid), 'Evidencia '+i));
      evDiv.appendChild(img); block.appendChild(evDiv);
    }
    blocksWrap.appendChild(block);
    }


// === Mostrar/ocultar y parametrizar bot√≥n "CUENTA" (debajo de Actividades) ===
const cuentaBtn = document.getElementById('btn-abrir-carpeta-cuenta');
const idCuenta = String(cu?.idCuenta || '').trim();

// Si hay idCuenta (BH), mostramos el bot√≥n y abrimos esa carpeta
if (idCuenta){
  cuentaBtn.classList.remove('hidden');
  // Limpiamos cualquier listener previo
  const nuevoBtn = cuentaBtn.cloneNode(true);
  cuentaBtn.parentNode.replaceChild(nuevoBtn, cuentaBtn);

  nuevoBtn.addEventListener('click', ()=>{
    playSoundOnce(SOUNDS.menu); // o SOUNDS.logout, como prefieras
    window.open('https://drive.google.com/drive/folders/' + idCuenta, '_blank');
  });
} else {
  // Si no hay BH, ocultamos el bot√≥n
  cuentaBtn.classList.add('hidden');
}
}
  
document.getElementById('rc-volver').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  showView('view-revision');
});
document.getElementById('rc-guardar').addEventListener('click', async ()=>{
  if(!REV_CUENTA?.cuenta){ Swal.fire({icon:'warning',title:'Sin cuenta cargada'}); return; }
  const documento = REV_CUENTA.contratista.documento;
  const nombre    = REV_CUENTA.contratista.nombre;
  const informe   = REV_CUENTA.cuenta.informe;
  const supervisor = supervisorNombreCompleto;
  const grupoId = 'HpfMVceAaM96quyxP3YSL1'; // grupo de contrataci√≥n
  const telContratistaRaw = REV_CUENTA.contratista.telefono;
  const observ = (document.getElementById('rc-observaciones').value || '').trim();
  const telContratista = normalizeNumber57(telContratistaRaw);

  const rs = await Swal.fire({
    icon:'success',
    title:`Haz revisado la cuenta N¬∞ ${informe} de ${nombre}`,
    text:'Toma una de las opciones.',
    showCancelButton:true,
    showDenyButton:true,
    confirmButtonText:'Aprobar',
    denyButtonText:'Devolver',
    cancelButtonText:'Cancelar'
  });

    function pieSupervisor(){ return supervisor === 'ANA JUDITH GAMBOA MANTILLA' ? '> Alcaldesa' : '> Supervisor(a)'; }

  function msgAprobadoContratista(){
    return (
      'Estimado(a) *'+nombre+'*' + '\n\n' +
      '¬°He firmado el Informe de Supervisi√≥n y solicitado al √°rea de contrataci√≥n validar tu *Cuenta N¬∞ '+informe+'*!,' + '\n\n' +
      'Espera atentamente la aprobaci√≥n.' + '\n\n' +
      'Cordialmente,' + '\n\n' +
      '*'+supervisor+'*' + '\n' + pieSupervisor()
    );
  }

  function msgAprobadoGrupo(){
    return (
      'Buen d√≠a *Equipo de Contrataci√≥n*' + '\n\n' +
      '¬°Por favor solicito la revisi√≥n de la *Cuenta N¬∞ '+informe+'*! Del contratista *'+nombre+'*.' + '\n\n' +
      'Cordialmente,' + '\n\n' +
      '*'+supervisor+'*' + '\n' + pieSupervisor()
    );
  }

  function msgDevueltaContratista(){
    return (
      'Estimado(a) *'+nombre+'*' + '\n\n' +
      'Se ha devuelto tu *Cuenta N¬∞ '+informe+'* por esta inconsistencia:' + '\n\n' +
      '*'+(observ || 'Sin observaciones')+'*' + '\n\n' +
      'Haz la correcci√≥n desde la *App Contratista* teniendo en cuenta las observaciones anteriores.' + '\n\n' +
      'Cordialmente,' + '\n\n' +
      '*'+supervisor+'*' + '\n' + pieSupervisor()
    );
  }

  if(rs.isConfirmed){
    try{
      await apiPost('aprobarCuentaSupervisor',{documento,informe,supervisor});
      if(telContratista){ sendBuilderbotMessage(telContratista, msgAprobadoContratista()); }
      sendBuilderbotMessage(grupoId, msgAprobadoGrupo());
      Swal.fire({icon:'success',title:'Cuenta Aprobada',timer:1800,showConfirmButton:false});
      await cargarCuentas(); showView('view-revision');
    }catch(e){ Swal.fire({icon:'error',title:'Error',text:e.message}); }
  } else if(rs.isDenied){
    try{
      await apiPost('devolverCuentaSupervisor',{documento,informe,observaciones:observ});
      if(telContratista){ sendBuilderbotMessage(telContratista, msgDevueltaContratista()); }
      Swal.fire({icon:'success',title:'Cuenta Devuelta',timer:1800,showConfirmButton:false});
      await cargarCuentas(); showView('view-revision');
    }catch(e){ Swal.fire({icon:'error',title:'Error',text:e.message}); }
  }
});

  /* ================== PLAN DE PAGOS ================== */

  document.getElementById('go-planes-pagos').addEventListener('click', async ()=>{
  overlay.classList.remove('open');
  await cargarPlanesPagos();
  showView('view-planes-pagos');
});
  
let PLANES_PAGOS_DATA = [];

async function cargarPlanesPagos(){
  try{
    const list = await apiGet('listPlanesPagos', { supervisor: supervisorNombreCompleto });
    PLANES_PAGOS_DATA = Array.isArray(list) ? list : [];
    pintarPlanesPagos(PLANES_PAGOS_DATA);
    actualizarResumenPlanesPagos(PLANES_PAGOS_DATA);
  }catch(e){
    PLANES_PAGOS_DATA = [];
    pintarPlanesPagos(PLANES_PAGOS_DATA);
    actualizarResumenPlanesPagos(PLANES_PAGOS_DATA);
    Swal.fire({icon:'error',title:'Error',text:e.message});
  }
}

function actualizarResumenPlanesPagos(list){
  const box = document.getElementById('planes-count');
  if(!list.length){ box.style.display='none'; box.textContent=''; return; }
  box.textContent = String(list.length);
  box.style.display='inline-block';
}

function pintarPlanesPagos(list){
  const wrap = document.getElementById('planes-list');
  wrap.innerHTML='';
  if(!list.length){
    wrap.innerHTML='<p class="muted center">No hay cuentas en Plan de Pagos.</p>';
    return;
  }
  for(const c of list){
    const div=document.createElement('div'); div.className='item-card';
    const header=document.createElement('div'); header.className='item-header';
    const title=document.createElement('p'); title.className='item-title'; title.textContent=(c.nombre||'');
    header.appendChild(title);
    div.appendChild(header);

    const pDoc=document.createElement('p'); pDoc.className='item-sub'; pDoc.textContent='CC: '+(c.documento||''); div.appendChild(pDoc);
    const pInf=document.createElement('p'); pInf.className='item-sub'; pInf.textContent='INFORME: '+(c.informe||'')+' de: '+(c.totalInformes||''); div.appendChild(pInf);

      const pEgreso=document.createElement('p');
    pEgreso.className='item-sub';
    pEgreso.textContent='FECHA √öLTIMO PAGO: ' + (c.fechaEgreso || 'Primera Cuenta');
    div.appendChild(pEgreso);
    
    const btnRow=document.createElement('div'); btnRow.className='btn-row';

    const btnCerrar=document.createElement('button');
    btnCerrar.textContent='CERRAR PROCESO';
    btnCerrar.addEventListener('click', ()=> {
      playSoundOnce(SOUNDS.logout);
      cerrarProcesoPlanPago(c.documento, c.informe);
    });
    btnRow.appendChild(btnCerrar);

    div.appendChild(btnRow);
    wrap.appendChild(div);
  }
}

document.getElementById('planes-filter').addEventListener('input', ()=>{
  const q=document.getElementById('planes-filter').value.trim().toLowerCase();
  const filtered = PLANES_PAGOS_DATA.filter(c=>{
    return [c.nombre,c.documento,c.informe,c.totalInformes].some(v=>String(v||'').toLowerCase().includes(q));
  });
  pintarPlanesPagos(filtered);
  actualizarResumenPlanesPagos(filtered);
});

document.getElementById('planes-volver').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  showView('view-inicio');
});

async function cerrarProcesoPlanPago(documento, informe){
  try{
    // Obtener detalles del contratista para mensajes
    const det = await apiGet('detallesContratistaSupervisor', { documento });
    if(!det){ Swal.fire({icon:'warning',title:'Contratista no encontrado'}); return; }
    const nombre = det.nombre || '';
    const telRaw = det.telefono || '';
    const telContratista = normalizeNumber57(telRaw);
    const supervisor = supervisorNombreCompleto;
    function pieSupervisor(){ return supervisor === 'ANA JUDITH GAMBOA MANTILLA' ? '> Alcaldesa' : '> Supervisor(a)'; }

    const msgContratista =
      'Estimado(a) *'+nombre+'*' + '\n\n' +
      '¬°He aceptado tu *Plan de Pagos* de la *Cuenta N¬∞ '+informe+'*!,' + '\n\n' +
      'Ya puedes entregar tus 2 paquetes organizados en el despacho de mi oficina.' + '\n\n' +
      'Cordialmente,' + '\n\n' +
      '*'+supervisor+'*' + '\n' + pieSupervisor();

    const msgGrupo =
      'Buen d√≠a *Equipo de Contabilidad*' + '\n\n' +
      '¬°Por favor solicito la orden de pago de la *Cuenta N¬∞ '+informe+'*! Del contratista *'+nombre+'*.' + '\n\n' +
      'Cordialmente,' + '\n\n' +
      '*'+supervisor+'*' + '\n' + pieSupervisor();

    // Enviar mensajes
    const grupoId = 'HpfMVceAaM96quyxP3YSL1';
    if(telContratista){ sendBuilderbotMessage(telContratista, msgContratista); }
    sendBuilderbotMessage(grupoId, msgGrupo);

    // Actualizar estado en la hoja
    await apiPost('cerrarPlanPagoSupervisor', { documento, informe, supervisor });

    Swal.fire({icon:'success',title:'Proceso Cerrado',timer:1800,showConfirmButton:false});
    await cargarPlanesPagos();
    showView('view-planes-pagos');
  }catch(e){
    Swal.fire({icon:'error',title:'Error',text:e.message});
  }
}

/* ================== REQUERIMIENTOS ================== */
let REQ_DATA=[];
document.getElementById('go-requerimientos').addEventListener('click', async ()=>{
  overlay.classList.remove('open');
  await cargarReqBase();
  showView('view-requerimientos');
});
async function cargarReqBase(){
  try{
    const list=await apiGet('listContratistasSupervisor', { supervisor: supervisorNombreCompleto });
    REQ_DATA=Array.isArray(list)?list:[];
    pintarReq(REQ_DATA); actualizarResumenReq(REQ_DATA);
  }catch(e){
    REQ_DATA=[]; pintarReq(REQ_DATA); actualizarResumenReq(REQ_DATA);
    Swal.fire({icon:'error',title:'Error',text:e.message});
  }
}
function actualizarResumenReq(list){
  const box=document.getElementById('req-count');
  if(!list.length){ box.style.display='none'; box.textContent=''; return; }
  box.textContent=String(list.length); box.style.display='inline-block';
}
function pintarReq(list){
  const wrap=document.getElementById('req-list'); wrap.innerHTML='';
  if(!list.length){ wrap.innerHTML='<p class="muted center">No hay contratistas.</p>'; return; }
  for(const c of list){
    const div=document.createElement('div'); div.className='item-card';
    const header=document.createElement('div'); header.className='item-header';
    const title=document.createElement('p'); title.className='item-title'; title.textContent=(c.nombre||'');
    header.appendChild(title); div.appendChild(header);
    const btnRow=document.createElement('div'); btnRow.className='btn-row';
    const btnRedact=document.createElement('button'); btnRedact.textContent='REDACTAR';
    btnRedact.addEventListener('click', ()=> {
  playSoundOnce(SOUNDS.logout);                 // ‚Üê SONIDO LOGOUT
  abrirModalReq(c);
});
    btnRow.appendChild(btnRedact); div.appendChild(btnRow);
    wrap.appendChild(div);
  }
}
document.getElementById('req-filter').addEventListener('input',()=>{
  const q=document.getElementById('req-filter').value.trim().toLowerCase();
  const filtered=REQ_DATA.filter(c=>[c.nombre,c.documento,c.secretaria,c.supervisor,c.telefono].some(v=>String(v||'').toLowerCase().includes(q)));
  pintarReq(filtered); actualizarResumenReq(filtered);
});
document.getElementById('req-volver').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  showView('view-inicio');
});

let MODAL_TARGET=null;
function abrirModalReq(c){
  MODAL_TARGET=c;
  document.getElementById('modal-req-text').value='';
  const modal=document.getElementById('modal-requerimiento');
  modal.classList.remove('hidden'); modal.classList.add('open');
}
document.getElementById('modal-ovl-back').addEventListener('click', ()=>{
  const modal=document.getElementById('modal-requerimiento');
  modal.classList.remove('open'); modal.classList.add('hidden');
});
document.getElementById('modal-close').addEventListener('click', ()=>{
  const modal=document.getElementById('modal-requerimiento');
  modal.classList.remove('open'); modal.classList.add('hidden');
});
document.getElementById('modal-req-enviar').addEventListener('click', ()=>{
  const txt=(document.getElementById('modal-req-text').value||'').trim();
  if(!MODAL_TARGET){ return; } if(!txt){ Swal.fire({icon:'warning',title:'Texto requerido'}); return; }
  const tel = normalizeNumber57(MODAL_TARGET.telefono);
  const nombre = (MODAL_TARGET.nombre || '').trim();
    const pie = supervisorNombreCompleto === 'ANA JUDITH GAMBOA MANTILLA' ? '> Alcaldesa' : '> Supervisor(a)';
  const mensaje =
    'Estimado(a) *' + nombre + '*' + '\n\n' +
    'Tenemos el siguiente requerimiento:' + '\n\n' +
    '*' + txt + '*' + '\n\n' +
    'Cordialmente,' + '\n\n' +
    '*' + supervisorNombreCompleto + '*' + '\n' + pie;
  if(tel){ sendBuilderbotMessage(tel, mensaje); }
  const modal=document.getElementById('modal-requerimiento');
  modal.classList.remove('open'); modal.classList.add('hidden');
  Swal.fire({icon:'success',title:'Requerimiento enviado',timer:1800,showConfirmButton:false});
});

/* ================== COMUNICADOS ================== */
document.getElementById('go-comunicados').addEventListener('click', ()=>{ overlay.classList.remove('open'); showView('view-comunicados'); });
document.getElementById('comunicado-enviar').addEventListener('click', async ()=>{
  const txt=(document.getElementById('comunicado-text').value||'').trim();
  if(!txt){ Swal.fire({icon:'warning',title:'Texto requerido'}); return; }
  try{
    await apiPost('guardarComunicadoSupervisor',{
      supervisor: supervisorNombreCompleto,
      comunicado: txt,
      imagenId: currentUser?.imagenId || ''  // guardamos ID (no URL)
    });
    Swal.fire({icon:'success',title:'COMUNICADO CARGADO CON √âXITO',timer:4000,showConfirmButton:false});
    document.getElementById('comunicado-text').value='';
    renderInicio(); showView('view-inicio');
  }catch(e){ Swal.fire({icon:'error',title:'Error',text:e.message}); }
});
document.getElementById('comunicado-volver').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  showView('view-inicio');
});

/* ================== SOPORTE ================== */
document.getElementById('go-soporte').addEventListener('click', ()=>{ overlay.classList.remove('open'); showView('view-soporte'); });
document.getElementById('soporte-enviar').addEventListener('click', async ()=>{
  const txt=(document.getElementById('soporte-text').value||'').trim();
  if(!txt){ Swal.fire({icon:'warning',title:'Texto requerido'}); return; }
  try{
    await apiPost('guardarSoporteSupervisor',{
      supervisor: supervisorNombreCompleto,
      soporte: txt,
      celular: ''  // no requerido; si quisieras capturar un campo, aqu√≠ se env√≠a
    });
    Swal.fire({icon:'success',title:'SOLICITUD CARGADA CON √âXITO',timer:4000,showConfirmButton:false});
    document.getElementById('soporte-text').value='';
    renderInicio(); showView('view-inicio');
  }catch(e){ Swal.fire({icon:'error',title:'Error',text:e.message}); }
});
document.getElementById('soporte-volver').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  showView('view-inicio');
});

/* ================== PWA AVANZADO ================== */
let deferredPrompt = null;
let __installStartShown = false;    // bandera: ya mostramos "App instal√°ndose"
let __installSuccessShown = false;  // bandera: ya mostramos "Instalaci√≥n exitosa"

function isStandalone(){
  const dmStandalone = window.matchMedia('(display-mode: standalone)').matches;
  const dmInstalled  = window.matchMedia('(display-mode: installed)').matches;
  const iosStandalone = (window.navigator.standalone === true);
  return dmStandalone || dmInstalled || iosStandalone;
}
function isIOS(){
  return /(iphone|ipad|ipod)/i.test(navigator.userAgent || '');
}
function isMarkedInstalled(){
  try{ return localStorage.getItem('pwaInstalledFlag') === '1'; }catch(_){ return false; }
}
function markInstalled(){
  try{ localStorage.setItem('pwaInstalledFlag', '1'); }catch(_){}
}
function clearInstalledMark(){
  try{ localStorage.removeItem('pwaInstalledFlag'); }catch(_){}
}
async function detectInstalled(){
  if (isStandalone()) return true;
  if (typeof navigator.getInstalledRelatedApps === 'function'){
    try{
      const apps = await navigator.getInstalledRelatedApps();
      const found = apps.some(a =>
        a.platform === 'webapp' &&
        typeof a.url === 'string' &&
        /manifest\.webmanifest$/.test(a.url)
      );
      if (found){
        markInstalled();
        return true;
      } else {
        clearInstalledMark();
      }
    }catch(_){}
  }
  return isMarkedInstalled();
}
function updateInstallButtonsVisibility(){
  const btn1 = document.getElementById('btn-instalar');
  const canPrompt = !!deferredPrompt;
  const installed = isMarkedInstalled() || isStandalone();
  const shouldShow = !installed && (canPrompt || isIOS());
  if(btn1) btn1.style.display = shouldShow ? '' : 'none';
}

window.addEventListener('beforeinstallprompt', (e)=>{
  e.preventDefault();
  deferredPrompt = e;
  updateInstallButtonsVisibility();
});

window.addEventListener('appinstalled', ()=>{
  markInstalled();
  deferredPrompt = null;
  updateInstallButtonsVisibility();
});

document.getElementById('btn-instalar').addEventListener('click', async ()=>{
  // Flujo iOS: se respeta exactamente tu alerta e instrucciones
  if(isIOS()){
    Swal.fire({
      icon:'info',
      title:'Para Instalar en tu Iphone',
      html:'1) Toca Compartir (cuadro con flecha en la parte inferior).<br>2) Elige "Agregar a pantalla de inicio".<br>3) Confirma "Agregar".'
    });
    return;
  }
  // Android: requiere beforeinstallprompt (deferredPrompt)
  if(!deferredPrompt){
    Swal.fire({icon:'info',title:'Instalaci√≥n no disponible todav√≠a'});
    return;
  }

  const dp = deferredPrompt;
  dp.prompt();                           // muestra di√°logo nativo de instalaci√≥n
  const choice = await dp.userChoice;    // espera la elecci√≥n del usuario
  deferredPrompt = null;                 // limpia el prompt (solo se usa una vez)

  if (choice.outcome === 'accepted'){
    // Primera alerta (Android): confirma inicio de instalaci√≥n por 6 segundos
    markInstalled();
    __installStartShown = true;
    Swal.fire({
  icon: 'success',
  title: '¬°App instal√°ndose!',
  html: `
    <div style="text-align:center; margin-top:8px;">
      <img
        src="https://res.cloudinary.com/dqqeavica/image/upload/v1764209976/Robot_c2vtua.gif"
        alt="Instalando app"
        style="width:180px; max-width:70vw; height:auto; display:block; margin:0 auto 12px;"
      >
      <div>Debes esperar unos segundos mientras el sistema instala la App.</div>
      <div style="margin-top:10px;">
        <b>Ya puedes salir de esta vista, aparecer√° en la pantalla principal de este dispositivo.</b>
      </div>
    </div>
  `,
  timer: 12000,
  showConfirmButton: false
});
  } else {
    Swal.fire({icon:'info',title:'Instalaci√≥n cancelada'});
  }

  updateInstallButtonsVisibility();
});

async function initPWAVista(){
  const installed = await detectInstalled();
  if (installed){
    showView('view-login');
  } else {
    showView('view-instalar');
    updateInstallButtonsVisibility();
  }
}
if ('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  });
}
window.addEventListener('load', initPWAVista);
  
// Helper para IDs con prefijo "add-"
function $id(base) {
  return document.getElementById('add-' + base) || document.getElementById(base);
}

/* ================== FIN ================== */
</script>
</body>
</html>
