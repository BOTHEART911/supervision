<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>SUPERVISI√ìN</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="icon" href="https://res.cloudinary.com/dqqeavica/image/upload/v1763928947/Logo_lt365u.png">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
  :root{
    --primary:#06402B;
    --primary-2:#04281C;
    --ok:#16a34a;
    --error:#dc2626;
    --scrim:rgba(0,0,0,.35);
  }
  html,body{
    margin:0; padding:0; height:100%; width:100%;
    overflow-x:hidden;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    color:#111;
    background: url('https://res.cloudinary.com/dqqeavica/image/upload/v1746905870/fondo_verde_tvntsi.png') center/cover fixed no-repeat;
  }
  .container{ max-width: 1100px; margin: 0 auto; padding: 16px; }

  .view{ display:none; opacity:0; transform: translateY(8px);
    transition: opacity .25s ease, transform .25s ease;
    box-sizing:border-box; padding:16px;
  }
  .view.active{ display:block; opacity:1; transform: translateY(0); }

  .card{
    background: rgba(255,255,255,.06);
    backdrop-filter: blur(3px);
    border: 2px solid #ddd;
    border-radius: 16px;
    box-shadow: 0 8px 20px rgba(0,0,0,.18);
    max-width: 820px;
    margin: 16px auto;
    padding: 20px 20px 16px;
  }
  h1,h2,h3{ margin: 8px 0 12px; text-align:center; }
  p.helper{ color:#444; font-size:.95rem; text-align:center; margin:8px 0 16px; }
  label{ display:block; font-weight:700; margin: 10px 0 6px; color:var(--primary); }
  input, select, textarea, button{
    width:100%; padding:12px; box-sizing:border-box;
    border:1.5px solid #ccc; border-radius:8px; background:#fff;
    outline:none; transition: border-color .2s ease, transform .08s ease;
    font-size:16px;
  }
  input:focus, select:focus, textarea:focus{ border-color:var(--primary); }
  button{
    cursor:pointer; border:2px solid var(--primary);
    background:#fff; color:#000; font-weight:700;
  }
  button:hover{ background:var(--primary-2); color:#fff; border-color:var(--primary-2); }
  .btn-primary{ background:var(--primary); color:#fff; }
  .btn-row{ display:flex; gap:12px; flex-wrap:wrap; }
  .btn-row > *{ flex:1; }
  .muted{ color:#666; font-size:.85rem; }
  .center{ text-align:center; }
  .image-center{ display:flex; justify-content:center; }
  .brand{ width:240px; border-radius:12px; display:block; margin:12px auto 4px; }
  .banner-bottom{ width:240px; border-radius:12px; display:block; margin:16px auto 8px; }
  .chip{
    padding:8px 12px; border-radius:999px; border:2px solid var(--primary);
    background:#fff; font-weight:700; color:#000; text-decoration:none;
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
  }
  .danger{ background:#e11; border-color:#e11; color:#fff; }

  .avatar{
    width: 112px; height: 112px; border-radius: 999px; border: 3px solid #fff;
    box-shadow: 0 6px 16px rgba(0,0,0,.18); object-fit: cover; background: #eee;
  }
  .firma-preview{
    width: 100%; max-width: 520px; border-radius: 12px; border: 2px solid #ddd; display:block;
    margin: 10px auto 0; background:#fff;
  }

  /* Loader centrado */
  .loader{
    position:fixed; inset:0;
    display:flex; align-items:center; justify-content:center;
    background:rgba(0,0,0,.35);
    z-index:9999; backdrop-filter: blur(2px);
    opacity:1; transition: opacity .12s ease;
    will-change: opacity;
  }
  .loader.hidden{
    opacity:0; pointer-events:none;
  }
  .spinner-ios{
    position:relative; width:64px; height:64px;
  }
  .spinner-ios i{
    position:absolute; left:50%; top:50%;
    width:6px; height:18px; margin:-9px 0 0 -3px;
    background:#fff; border-radius:3px;
    opacity:.2;
    animation:iosFade 1.2s linear infinite;
    transform-origin: center center;
  }
  @keyframes iosFade{
    0%, 39%, 100% { opacity:.2; }
    40% { opacity:1; }
  }
  .spinner-ios i:nth-child(1)  { transform: rotate(  0deg) translateY(-24px); animation-delay:-1.1s; }
  .spinner-ios i:nth-child(2)  { transform: rotate( 30deg) translateY(-24px); animation-delay:-1.0s; }
  .spinner-ios i:nth-child(3)  { transform: rotate( 60deg) translateY(-24px); animation-delay:-0.9s; }
  .spinner-ios i:nth-child(4)  { transform: rotate( 90deg) translateY(-24px); animation-delay:-0.8s; }
  .spinner-ios i:nth-child(5)  { transform: rotate(120deg) translateY(-24px); animation-delay:-0.7s; }
  .spinner-ios i:nth-child(6)  { transform: rotate(150deg) translateY(-24px); animation-delay:-0.6s; }
  .spinner-ios i:nth-child(7)  { transform: rotate(180deg) translateY(-24px); animation-delay:-0.5s; }
  .spinner-ios i:nth-child(8)  { transform: rotate(210deg) translateY(-24px); animation-delay:-0.4s; }
  .spinner-ios i:nth-child(9)  { transform: rotate(240deg) translateY(-24px); animation-delay:-0.3s; }
  .spinner-ios i:nth-child(10) { transform: rotate(270deg) translateY(-24px); animation-delay:-0.2s; }
  .spinner-ios i:nth-child(11) { transform: rotate(300deg) translateY(-24px); animation-delay:-0.1s; }
  .spinner-ios i:nth-child(12) { transform: rotate(330deg) translateY(-24px); animation-delay: 0s; }

  .hidden{ display:none !important; }
  .narrow{ max-width: 560px; margin: 0 auto; }
  .spaced{ margin-top:12px; }

  .list-grid{ display:flex; flex-direction:column; gap:14px; margin-top:14px; }
  .item-card{
    background: rgba(255,255,255,.06);
    backdrop-filter: blur(3px);
    border: 2px solid #ddd;
    border-radius:16px; padding:14px 16px;
    box-shadow:0 6px 14px rgba(0,0,0,.12);
    display:flex; flex-direction:column; gap:6px;
  }
  .item-header{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:space-between; }
  .item-title{ font-weight:900; font-size:1rem; color:var(--primary); margin:0; }
  .item-sub{ font-size:.72rem; font-weight:700; color:#333; margin:0; }

  .chip-link{ display:inline-flex; align-items:center; gap:8px; }

  @media (max-width:700px){ .btn-row{ flex-direction:column; } }
  </style>
</head>
<body>
  <!-- Loader -->
  <div id="loader" class="loader hidden" aria-live="polite" aria-busy="true">
    <div class="spinner-ios" role="status" aria-label="Cargando">
      <i></i><i></i><i></i><i></i><i></i><i></i>
      <i></i><i></i><i></i><i></i><i></i><i></i>
    </div>
  </div>

  <div class="container">

    <!-- VISTA INSTALAR -->
    <section id="view-instalar" class="view">
      <div class="card narrow" style="text-align:center;">
        <h2 style="color:var(--primary);">APP SUPERVISI√ìN</h2>
        <img class="brand" alt="Instalar" src="https://res.cloudinary.com/dqqeavica/image/upload/v1763930524/menu_t9xli7.gif" />
        <p style="font-weight:600;">Herramienta de uso exclusivo para Supervisoras y Supervisores de la Alcald√≠a de Flandes</p>
        <div class="btn-row" style="justify-content:center; margin-top:12px;">
          <button id="btn-instalar" class="btn-primary" style="display:none;">Instalar la App üì≤</button>
        </div>
        <p class="muted" style="margin-top:14px;">Si ya instalaste la App y no se inicia autom√°ticamente, refresca en unos segundos.</p>
      </div>
    </section>

    <!-- VISTA LOGIN -->
    <section id="view-login" class="view">
      <div class="card narrow">
        <h1 style="color:var(--primary); text-shadow: 0 2px 2px #031732;">SUPERVISI√ìN</h1>
        <p class="helper"><b>Solo Supervisores autorizados pueden usar esta App.</b></p>

        <label>C√©dula</label>
        <input id="login-cedula" type="tel" inputmode="numeric" autocomplete="off" placeholder="Sin puntos ni espacios" />

        <div class="btn-row spaced">
          <button class="btn-primary" id="btn-login">Iniciar Sesi√≥n</button>
        </div>

        <img class="banner-bottom" alt="Banner" src="https://res.cloudinary.com/dqqeavica/image/upload/v1763921425/Digital_sw3wk9.gif" />
        <p class="center muted">Copyright ¬© <b>GOBIERNO DIGITAL</b></p>
      </div>
    </section>

    <!-- VISTA COMPLETA TU REGISTRO -->
    <section id="view-completar" class="view">
      <div class="card narrow">
        <h2 style="color:var(--primary)">COMPLETA TU REGISTRO</h2>
        <p class="helper"><b>Sube tu Firma (requerida) y tu Imagen de Perfil (opcional)</b></p>

        <label>Tu Firma (requerido)</label>
        <input type="file" id="reg-firma" accept="image/*" />
        <img id="reg-firma-preview" src="" alt="Firma (vista previa)" style="display:none; max-width:100%; border-radius:10px; border:1.5px solid #d8e4ff; margin-top:8px;" />

        <label>Foto de Perfil (opcional)</label>
        <p class="desc">Adjunta la foto</p>
        <input type="file" id="reg-foto" accept="image/*" />
        <img id="reg-preview" src="" alt="Vista previa" style="display:none; max-width:100%; border-radius:10px; border:1.5px solid #d8e4ff; margin-top:8px;" />

        <div class="btn-row spaced">
          <button id="btn-guardar-reg" class="btn-primary">Guardar</button>
          <button id="btn-cancelar-reg">Cancelar</button>
        </div>
      </div>
    </section>

    <!-- VISTA INICIO -->
    <section id="view-inicio" class="view">
      <div class="card">
        <div class="btn-row" style="margin-bottom:12px;">
          <button class="danger" id="btn-logout">Cerrar Sesi√≥n</button>
          <button class="chip" id="btn-open-menu">Men√∫</button>
        </div>

        <div class="image-center">
          <img id="inicio-avatar" class="avatar" alt="Avatar">
        </div>
        <h2 id="inicio-rol" style="color:var(--primary); font-weight:900;">SUPERVISOR(A)</h2>
        <p class="center" style="font-weight:800;" id="inicio-nombre"></p>

        <img id="inicio-firma" class="firma-preview hidden" alt="Firma supervisi√≥n">

        <div class="btn-row spaced">
          <button id="go-contratistas" class="btn-primary">CONTRATISTAS</button>
          <button id="go-revision" class="btn-primary">REVISAR CUENTAS</button>
          <button id="go-requerimientos" class="btn-primary">REQUERIMIENTO</button>
          <button id="go-comunicados" class="btn-primary">COMUNICADOS</button>
          <button id="go-soporte" class="btn-primary">SOPORTE</button>
        </div>

        <img class="banner-bottom" alt="Banner" src="https://res.cloudinary.com/dqqeavica/image/upload/v1763921425/Digital_sw3wk9.gif" />
        <p class="center muted">Copyright ¬© <b>GOBIERNO DIGITAL</b></p>
      </div>
    </section>

    <!-- VISTA CONTRATISTAS -->
    <section id="view-contratistas" class="view">
      <div class="card">
        <h2 style="color:var(--primary)">CONTRATISTAS</h2>

        <div class="center">
          <div id="contr-count" class="chip">0</div>
          <p id="contr-caption" class="muted" style="margin:6px 0 12px;">N¬∞ de Contratistas asignados</p>
        </div>

        <input id="contr-filter" class="filter-input" type="text" placeholder="Filtrar por nombre, documento, secretar√≠a o tel√©fono" aria-label="Filtrar contratistas">

        <div class="btn-row spaced">
          <button id="contr-volver" class="danger">REGRESAR</button>
        </div>

        <div id="contr-list" class="list-grid"></div>
      </div>
    </section>

    <!-- VISTA REVISI√ìN DE CUENTAS (LISTA) -->
    <section id="view-revision" class="view">
      <div class="card">
        <h2 style="color:var(--primary)">REVISAR CUENTAS</h2>

        <div class="center">
          <div id="cuentas-count" class="chip">0</div>
          <p class="muted" style="margin:6px 0 12px;">N¬∞ de Cuentas INGRESADAS</p>
        </div>

        <input id="cuentas-filter" class="filter-input" type="text" placeholder="Filtrar por nombre, documento o informe">

        <div class="btn-row spaced">
          <button id="revision-volver" class="danger">REGRESAR</button>
        </div>

        <div id="cuentas-list" class="list-grid"></div>
      </div>
    </section>

    <!-- VISTA REVISAR CUENTA -->
    <section id="view-revisar-cuenta" class="view">
      <div class="card">
        <h2 id="rc-title" style="color:var(--primary)">REVISI√ìN DE CUENTA</h2>
        <div id="rc-body" class="narrow"></div>

        <h3 style="color:var(--primary); margin-top:18px;">OBSERVACI√ìN (si vas a devolver)</h3>
        <textarea id="rc-observaciones" rows="4" placeholder="Escribe la observaci√≥n"></textarea>

        <div class="btn-row spaced">
          <button id="rc-aprobar" class="btn-primary">Aprobar</button>
          <button id="rc-devolver" class="danger">Devolver</button>
          <button id="rc-volver">Regresar</button>
        </div>
      </div>
    </section>

    <!-- VISTA REQUERIMIENTO -->
    <section id="view-requerimientos" class="view">
      <div class="card">
        <h2 style="color:var(--primary)">REQUERIMIENTO</h2>
        <div id="req-list" class="list-grid"></div>
        <div class="btn-row spaced">
          <button id="req-volver" class="danger">REGRESAR</button>
        </div>
      </div>
    </section>

    <!-- MODAL REQUERIMIENTO -->
    <div id="modal-requerimiento" class="loader hidden" style="background:rgba(0,0,0,.55);">
      <div class="card narrow" style="max-width:520px;">
        <h3 style="color:var(--primary)">Redacta tu Requerimiento</h3>
        <textarea id="modal-req-text" rows="5" placeholder="Redacta el Requerimiento"></textarea>
        <div class="btn-row" style="margin-top:14px;">
          <button id="modal-req-enviar" class="btn-primary">Enviar</button>
          <button id="modal-req-cancelar" class="danger">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- VISTA COMUNICADOS -->
    <section id="view-comunicados" class="view">
      <div class="card narrow">
        <h2 style="color:var(--primary)">EMITE COMUNICADO</h2>
        <textarea id="comunicado-text" rows="6" placeholder="Escribe tu comunicado"></textarea>
        <div class="btn-row spaced">
          <button id="comunicado-enviar" class="btn-primary">Enviar</button>
          <button id="comunicado-volver" class="danger">Regresar</button>
        </div>
      </div>
    </section>

    <!-- VISTA SOPORTE -->
    <section id="view-soporte" class="view">
      <div class="card narrow">
        <h2 style="color:var(--primary)">¬øQU√â NECESITAS?</h2>
        <textarea id="soporte-text" rows="6" placeholder="Redacta detalladamente tu pregunta o sugerencia"></textarea>
        <div class="btn-row spaced">
          <button id="soporte-enviar" class="btn-primary">Enviar</button>
          <button id="soporte-volver" class="danger">Regresar</button>
        </div>
      </div>
    </section>

    <!-- OVERLAY MEN√ö -->
    <div class="overlay hidden" id="overlay" style="position:fixed; inset:0;">
      <div id="ovl-scrim" style="position:absolute; inset:0; background:var(--scrim);"></div>
      <aside class="panel" style="position:absolute; top:0; left:0; width:min(360px, 90vw); height:100%; background:#2f6bdb; color:#fff; padding:16px; box-sizing:border-box; transform:translateX(-100%); transition:.25s;">
        <div class="btn-row">
          <button id="btn-ovl-back">ATR√ÅS</button>
        </div>
        <div class="image-center">
          <img alt="banner" src="https://res.cloudinary.com/dqqeavica/image/upload/v1763930524/menu_t9xli7.gif" style="max-width:180px;border-radius:10px;" />
        </div>
        <h3 style="text-align:center;">Selecciona una opci√≥n</h3>
        <button class="chip" id="ovl-actualizar">ACTUALIZAR FIRMA E IMAGEN</button>
        <button class="chip" id="ovl-contratistas">CONTRATISTAS</button>
        <button class="chip" id="ovl-revisar">REVISAR CUENTAS</button>
        <button class="chip" id="ovl-requerimiento">REQUERIMIENTO</button>
        <button class="chip" id="ovl-comunicados">COMUNICADOS</button>
        <button class="chip" id="ovl-soporte">SOPORTE</button>
        <img class="brand" alt="Banner" src="https://res.cloudinary.com/dqqeavica/image/upload/v1763921425/Digital_sw3wk9.gif" />
        <p class="center muted">Copyright ¬© <b>GOBIERNO DIGITAL</b></p>
      </aside>
    </div>

  </div>

<script>
/* ================== CONFIG ================== */
// Reemplazar con la URL de despliegue del Apps Script para SUPERVISI√ìN
const API_BASE = 'https://script.google.com/macros/s/AKfycbxODAokpEb3RRzeVlrriddyzbYxRwcLPh2ymehmBU_iM7zx4hLCWwcuHH5mV1qcIc0xAw/exec';
const BUILDERBOT_ENDPOINT = 'https://app.builderbot.cloud/api/v2/ff37a123-12b0-4fdc-9866-f3e2daf389fb/messages';
const BUILDERBOT_API_KEY  = 'bb-7f9ef630-5cfc-4ba4-9258-5e7cecbb4f65';

/* ================== SONIDOS ================== */
const SOUNDS = {
  question: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Pay_fail_ls2aif.mp3',
  info: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Default_notification_pkp4wr.mp3',
  success: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Pay_success_t5aawh.mp3',
  error: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Low_battery_d5qua1.mp3',
  warning: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Low_battery_d5qua1.mp3',
  login: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Siri_star_g1owy4.mp3',
  logout: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Siri_End_kelv02.mp3',
  back: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Keyboard_Enter_b9k2dc.mp3'
};
function playSoundOnce(url){
  try{ const a=new Audio(url); a.preload='auto'; a.play().catch(()=>{});}catch(e){}
}
if (window.Swal && typeof Swal.fire === 'function'){
  const __fire = Swal.fire.bind(Swal);
  Swal.fire = function(options = {}, ...rest){
    try{
      const icon = options.icon || options.type;
      if (icon && SOUNDS[icon]) playSoundOnce(SOUNDS[icon]);
    }catch(e){}
    return __fire(options, ...rest);
  }
}

/* ================== LOADER ================== */
const loader = document.getElementById('loader');
let loadingCount = 0, loaderTimer = null;
function startLoading(){ loadingCount++; if(loadingCount===1){ loaderTimer=setTimeout(()=>{loader.classList.remove('hidden'); loaderTimer=null;},120);} }
function stopLoading(){ if(loadingCount===0) return; loadingCount--; if(loadingCount===0){ if(loaderTimer){clearTimeout(loaderTimer); loaderTimer=null;} loader.classList.add('hidden'); }}

/* ================== API ================== */
async function apiGet(action, params = {}){
  startLoading();
  try{
    const url = new URL(API_BASE);
    url.search = new URLSearchParams({action, ...params}).toString();
    const r = await fetch(url.toString());
    const j = await r.json();
    if(!j.ok) throw new Error(j.error || 'Error');
    return j.data;
  } finally { stopLoading(); }
}
async function apiPost(action, body = {}){
  startLoading();
  try{
    const url = API_BASE + '?action=' + encodeURIComponent(action);
    const r = await fetch(url, { method:'POST', headers:{'Content-Type':'text/plain;charset=utf-8'}, body: JSON.stringify(body) });
    const j = await r.json();
    if(!j.ok) throw new Error(j.error || 'Error');
    return j.data;
  } finally { stopLoading(); }
}

/* ================== BUILDERBOT ================== */
function normalizeNumber(raw){
  let num = String(raw||'').replace(/\D/g,'');
  if(!num) return '';
  if(num.length===10 && !num.startsWith('57')) num = '57'+num;
  if(!(num.length===12 && num.startsWith('57'))) return '';
  return num;
}
function sendBuilderbotMessage(destino, mensaje){
  const numberField = String(destino||'').trim();
  if(!numberField) return;
  fetch(BUILDERBOT_ENDPOINT, {
    method:'POST',
    headers:{ 'Content-Type':'application/json', 'x-api-builderbot':BUILDERBOT_API_KEY },
    body: JSON.stringify({ messages:{content:mensaje}, number:numberField, checkIfExists:false })
  }).catch(()=>{});
}

/* ================== ESTADO ================== */
let currentUser = null;   // { cedula, supervisor, firmaId, imagenUrl }

/* ================== VISTAS ================== */
function showView(id){
  for(const el of document.querySelectorAll('.view')) el.classList.remove('active');
  const v = document.getElementById(id);
  if(v) v.classList.add('active');
  window.scrollTo({ top:0, behavior:'smooth' });
}

/* ================== LOGIN ================== */
document.getElementById('btn-login').addEventListener('click', async ()=>{
  const cedula = (document.getElementById('login-cedula').value||'').trim();
  if(!/^\d{6,10}$/.test(cedula)){
    Swal.fire({icon:'warning',title:'C√©dula inv√°lida',text:'Debe tener de 6 a 10 d√≠gitos SIN PUNTOS NI ESPACIOS'}); return;
  }
  try{
    const res = await apiGet('loginSupervisor', { cedula });
    if(!res || !res.encontrado){
      return Swal.fire({icon:'error',title:'SIN ACCESO',text:'No est√°s autorizado.'});
    }
    currentUser = {
      cedula,
      supervisor: res.supervisor || '',
      firmaId: res.firmaId || '',
      imagenUrl: res.imagenUrl || ''
    };
    if(!currentUser.firmaId){
      await Swal.fire({icon:'success',title:`${currentUser.supervisor} completa tu registro`, text:'Solo debes ingresar la imagen de tu firma', confirmButtonText:'Ok'});
      showView('view-completar');
    }else{
      renderInicio();
      playSoundOnce(SOUNDS.login);
      showView('view-inicio');
    }
  }catch(e){
    Swal.fire({icon:'error',title:'Error',text:e.message});
  }
});

/* ================== COMPLETAR / ACTUALIZAR REGISTRO ================== */
// Compresi√≥n de imagen
async function compressImage(file, maxDim = 1280, quality = 0.7){
  return new Promise((resolve, reject)=>{
    try{
      const reader = new FileReader();
      reader.onload = ev => {
        const img = new Image();
        img.onload = ()=>{
          const canvas = document.createElement('canvas');
          let {width, height} = img;
          const scale = Math.min(1, maxDim / Math.max(width,height));
          width = Math.round(width*scale); height = Math.round(height*scale);
          canvas.width = width; canvas.height = height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);
          const dataUrl = canvas.toDataURL('image/jpeg', quality);
          resolve(dataUrl);
        };
        img.onerror = ()=> reject(new Error('No se pudo procesar la imagen.'));
        img.src = ev.target.result;
      };
      reader.onerror = ()=> reject(new Error('No se pudo leer el archivo.'));
      reader.readAsDataURL(file);
    }catch(e){ reject(e); }
  });
}
let regFirmaDataUrl = '';
let regFotoDataUrl  = '';

document.getElementById('reg-firma')?.addEventListener('change', async (e)=>{
  const file = e.target.files && e.target.files[0];
  const preview = document.getElementById('reg-firma-preview');
  if(!file){ regFirmaDataUrl=''; preview.style.display='none'; preview.src=''; return; }
  try{
    const compressed = await compressImage(file, 1280, 0.8);
    regFirmaDataUrl = compressed; preview.src = regFirmaDataUrl; preview.style.display='block';
  }catch(_){
    const reader = new FileReader();
    reader.onload = ev => { regFirmaDataUrl = ev.target.result; preview.src = regFirmaDataUrl; preview.style.display='block'; };
    reader.readAsDataURL(file);
  }
});
document.getElementById('reg-foto')?.addEventListener('change', async (e)=>{
  const file = e.target.files && e.target.files[0];
  const preview = document.getElementById('reg-preview');
  if(!file){ regFotoDataUrl=''; preview.style.display='none'; preview.src=''; return; }
  try{
    const compressed = await compressImage(file, 1280, 0.7);
    regFotoDataUrl = compressed; preview.src = regFotoDataUrl; preview.style.display='block';
  }catch(_){
    const reader = new FileReader();
    reader.onload = ev => { regFotoDataUrl = ev.target.result; preview.src = regFotoDataUrl; preview.style.display='block'; };
    reader.readAsDataURL(file);
  }
});

document.getElementById('btn-guardar-reg').addEventListener('click', async ()=>{
  if(!currentUser?.cedula){ return; }
  if(!regFirmaDataUrl){
    Swal.fire({icon:'warning',title:'Firma requerida',text:'Adjunta la imagen de tu firma'}); return;
  }
  try{
    const data = await apiPost('guardarFirmaImagenSupervisor', {
      cedula: currentUser.cedula,
      firmaDataUrl: regFirmaDataUrl,
      imagenDataUrl: regFotoDataUrl || ''
    });
    currentUser.firmaId = data.firmaId || '';
    currentUser.imagenUrl = data.imagenUrl || '';
    Swal.fire({icon:'success',title:'Datos guardados',timer:1800,showConfirmButton:false});
    renderInicio();
    showView('view-inicio');
  }catch(e){
    Swal.fire({icon:'error',title:'Error',text:e.message});
  }
});
document.getElementById('btn-cancelar-reg').addEventListener('click', ()=>{
  showView('view-login');
});

/* ================== INICIO ================== */
function driveThumbById(id){ return id ? ('https://drive.google.com/thumbnail?sz=w1000&id='+id) : ''; }
function renderInicio(){
  // Avatar: si hay imagenUrl usarla, si no emoji usuario
  const avatar = document.getElementById('inicio-avatar');
  if(currentUser?.imagenUrl){
    avatar.src = currentUser.imagenUrl;
  }else{
    avatar.src = 'https://res.cloudinary.com/dqqeavica/image/upload/v1758738139/user_zefosv.png';
  }
  document.getElementById('inicio-rol').textContent = 'SUPERVISOR(A)';
  document.getElementById('inicio-nombre').textContent = currentUser?.supervisor || '';

  // Firma: previsualizar si hay firmaId
  const imgFirma = document.getElementById('inicio-firma');
  if(currentUser?.firmaId){
    imgFirma.src = driveThumbById(currentUser.firmaId);
    imgFirma.classList.remove('hidden');
  }else{
    imgFirma.classList.add('hidden');
  }
}
document.getElementById('btn-logout').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.logout);
  currentUser = null; regFirmaDataUrl=''; regFotoDataUrl='';
  showView('view-login');
});

/* ================== OVERLAY MEN√ö ================== */
const overlay = document.getElementById('overlay');
const panel   = overlay?.querySelector('.panel');
function openOverlay(){
  overlay.classList.remove('hidden');
  requestAnimationFrame(()=>{ panel.style.transform = 'translateX(0)'; });
}
function closeOverlay(){
  panel.style.transform = 'translateX(-100%)';
  setTimeout(()=> overlay.classList.add('hidden'), 220);
}
document.getElementById('btn-open-menu').addEventListener('click', openOverlay);
document.getElementById('btn-ovl-back').addEventListener('click', closeOverlay);
document.getElementById('ovl-scrim').addEventListener('click', closeOverlay);
document.getElementById('ovl-actualizar').addEventListener('click', ()=>{ closeOverlay(); showView('view-completar'); });
document.getElementById('ovl-contratistas').addEventListener('click', async ()=>{ closeOverlay(); await cargarContratistas(); showView('view-contratistas'); });
document.getElementById('ovl-revisar').addEventListener('click', async ()=>{ closeOverlay(); await cargarCuentas(); showView('view-revision'); });
document.getElementById('ovl-requerimiento').addEventListener('click', async ()=>{ closeOverlay(); await cargarRequerimientosBase(); showView('view-requerimientos'); });
document.getElementById('ovl-comunicados').addEventListener('click', ()=>{ closeOverlay(); showView('view-comunicados'); });
document.getElementById('ovl-soporte').addEventListener('click', ()=>{ closeOverlay(); showView('view-soporte'); });

/* ================== CONTRATISTAS ================== */
let CONTR_DATA=[];
async function cargarContratistas(){
  try{
    const list = await apiGet('listContratistasSupervisor', { supervisor: currentUser?.supervisor || '' });
    CONTR_DATA = Array.isArray(list) ? list : [];
    pintarContratistas(CONTR_DATA);
    document.getElementById('contr-count').textContent = String(CONTR_DATA.length||0);
  }catch(e){
    CONTR_DATA=[]; pintarContratistas(CONTR_DATA);
    Swal.fire({icon:'error',title:'Error',text:e.message});
  }
}
function pintarContratistas(list){
  const wrap=document.getElementById('contr-list');
  wrap.innerHTML='';
  if(!list.length){
    wrap.innerHTML='<p class="muted center">No hay contratistas asignados.</p>'; return;
  }
  for(const c of list){
    const card=document.createElement('div'); card.className='item-card';
    const header=document.createElement('div'); header.className='item-header';
    const title=document.createElement('p'); title.className='item-title'; title.textContent=(c.nombre||'');
    header.appendChild(title); card.appendChild(header);

    const sub1=document.createElement('p'); sub1.className='item-sub'; sub1.textContent='CC: '+(c.documento||''); card.appendChild(sub1);
    const sub2=document.createElement('p'); sub2.className='item-sub'; sub2.textContent='SECRETAR√çA: '+(c.secretaria||''); card.appendChild(sub2);
    const sub3=document.createElement('p'); sub3.className='item-sub'; sub3.textContent='SUPERVISOR(A): '+(c.supervisor||''); card.appendChild(sub3);

    const btns=document.createElement('div'); btns.className='btn-row';
    const btnDet=document.createElement('button'); btnDet.textContent='MOSTRAR DETALLES';
    btnDet.addEventListener('click', async ()=>{
      try{
        const d = await apiGet('detallesContratista', { documento: c.documento });
        const lines=[];
        if(d){
          lines.push(`<b>NOMBRE:</b> ${d.nombre||''}`);
          lines.push(`<b>CC:</b> ${d.documento||''}`);
          lines.push(`<b>SECRETAR√çA:</b> ${d.secretaria||''}`);
          lines.push(`<b>SUPERVISOR:</b> ${d.supervisor||''}`);
          lines.push(`<b>CONTRATO:</b> ${d.contrato||''} de: ${d.fechaContrato||''}`);
          lines.push(`<b>OBJETO:</b> ${d.objeto||''}`);
          for(let i=1;i<=26;i++){ const v=d['obligacion'+i]; if(v && v!=='-'){ lines.push(`<b>OBLIGACI√ìN ${i}:</b> ${v}`); } }
        }
        Swal.fire({icon:'info',title:'DETALLES', html: lines.map(l=>`<p style="text-align:left;margin:4px 0;">${l}</p>`).join(''), width: '680px'});
      }catch(e){ Swal.fire({icon:'error',title:'Error',text:e.message}); }
    });
    btns.appendChild(btnDet);
    card.appendChild(btns);

    wrap.appendChild(card);
  }
}
document.getElementById('contr-filter').addEventListener('input', ()=>{
  const q = document.getElementById('contr-filter').value.trim().toLowerCase();
  const filtered = CONTR_DATA.filter(c=>{
    return [c.nombre,c.documento,c.secretaria,c.supervisor,c.telefono].some(v=>String(v||'').toLowerCase().includes(q));
  });
  pintarContratistas(filtered);
  document.getElementById('contr-count').textContent = String(filtered.length||0);
});
document.getElementById('contr-volver').addEventListener('click', ()=> showView('view-inicio'));

/* ================== REVISI√ìN ================== */
let CUENTAS_DATA=[];
async function cargarCuentas(){
  try{
    const list = await apiGet('listCuentasSupervisor', { supervisor: currentUser?.supervisor || '' });
    CUENTAS_DATA = Array.isArray(list) ? list : [];
    pintarCuentas(CUENTAS_DATA);
    document.getElementById('cuentas-count').textContent = String(CUENTAS_DATA.length||0);
  }catch(e){
    CUENTAS_DATA=[]; pintarCuentas(CUENTAS_DATA);
    Swal.fire({icon:'error',title:'Error',text:e.message});
  }
}
function pintarCuentas(list){
  const wrap=document.getElementById('cuentas-list');
  wrap.innerHTML='';
  if(!list.length){ wrap.innerHTML='<p class="muted center">No hay cuentas ingresadas.</p>'; return; }
  for(const c of list){
    const card=document.createElement('div'); card.className='item-card';
    const header=document.createElement('div'); header.className='item-header';
    const title=document.createElement('p'); title.className='item-title'; title.textContent=(c.nombre||''); header.appendChild(title); card.appendChild(header);
    const sub1=document.createElement('p'); sub1.className='item-sub'; sub1.textContent='CC: '+(c.documento||''); card.appendChild(sub1);
    const sub2=document.createElement('p'); sub2.className='item-sub'; sub2.textContent='INFORME: '+(c.informe||'')+' de '+(c.totalInformes||''); card.appendChild(sub2);

    const btns=document.createElement('div'); btns.className='btn-row';
    const btnRev=document.createElement('button'); btnRev.textContent='REVISAR';
    btnRev.addEventListener('click', async ()=>{
      try{
        const det = await apiGet('revisarCuentaDataSupervisor', { documento: c.documento, supervisor: currentUser?.supervisor || '' });
        if(!det){ return Swal.fire({icon:'info',title:'No encontrado'}); }
        REV_CUENTA = det;
        renderRC();
        showView('view-revisar-cuenta');
      }catch(e){ Swal.fire({icon:'error',title:'Error',text:e.message}); }
    });
    btns.appendChild(btnRev); card.appendChild(btns);
    wrap.appendChild(card);
  }
}
document.getElementById('cuentas-filter').addEventListener('input', ()=>{
  const q=document.getElementById('cuentas-filter').value.trim().toLowerCase();
  const filtered=CUENTAS_DATA.filter(c=>[c.nombre,c.documento,c.informe,c.totalInformes].some(v=>String(v||'').toLowerCase().includes(q)));
  pintarCuentas(filtered);
  document.getElementById('cuentas-count').textContent = String(filtered.length||0);
});
document.getElementById('revision-volver').addEventListener('click', ()=> showView('view-inicio'));

/* === Revisar cuenta detalle === */
let REV_CUENTA=null;
function renderRC(){
  const c = REV_CUENTA?.contratista;
  const cu = REV_CUENTA?.cuenta;
  const rcTitle = document.getElementById('rc-title');
  const rcBody = document.getElementById('rc-body');
  rcTitle.textContent = 'REVISI√ìN DE CUENTA N¬∞ '+(cu?.informe||'')+' de '+(c?.nombre||'');
  const lines=[
    `<b>DOCUMENTO:</b> ${c?.documento||''}`,
    `<b>SECRETAR√çA:</b> ${c?.secretaria||''}`,
    `<b>SUPERVISOR:</b> ${c?.supervisor||''}`,
    `<b>FECHA RADICACI√ìN:</b> ${cu?.fechaRadicacion||''}`,
    `<b>INICIO RATIFICADO:</b> ${cu?.inicioRatificar||''}`,
    `<b>FIN RATIFICADO:</b> ${cu?.finRatificar||''}`,
    `<b>SALDO ACTUAL:</b> ${cu?.saldoActual||''}`,
    `<b>VALOR COBRADO:</b> ${cu?.menos||''}`,
    `<b>NUEVO SALDO:</b> ${cu?.nuevoSaldo||''}`
  ];
  rcBody.innerHTML = lines.map(l=>`<p>${l}</p>`).join('');
}
document.getElementById('rc-volver').addEventListener('click', ()=> showView('view-revision'));

document.getElementById('rc-aprobar').addEventListener('click', async ()=>{
  if(!REV_CUENTA) return;
  try{
    const documento = REV_CUENTA.contratista.documento;
    const informe   = REV_CUENTA.cuenta.informe;
    await apiPost('aprobarCuentaSupervisor', {
      documento, informe,
      supervisor: currentUser?.supervisor || ''
    });

    // Mensajes WhatsApp
    const nombre = REV_CUENTA.contratista.nombre;
    const supervisor = currentUser?.supervisor || '';
    const telContratista = normalizeNumber(REV_CUENTA.contratista.telefono);
    const grupoId = 'HpfMVceAaM96quyxP3YSL1';

    const msgContr =
      'Estimado(a) *'+nombre+'*\n\n' +
      '¬°He firmado el Informe de Supervisi√≥n y solicitado al √°rea de contrataci√≥n validar tu *Cuenta N¬∞ '+informe+'*!,\n\n' +
      'Espera atentamente la aprobaci√≥n.\n\n' +
      'Cordialmente,\n\n' +
      '*'+supervisor+'*\n> Supervisor(a)';

    const msgGrupo =
      'Buen d√≠a *Equipo de Contrataci√≥n*\n\n' +
      '¬°Por favor solicito la revisi√≥n de la *Cuenta N¬∞ '+informe+'*! Del contratista *'+nombre+'*,\n\n' +
      'Cordialmente,\n\n*'+supervisor+'*\n> Supervisor(a)';

    if(telContratista) sendBuilderbotMessage(telContratista, msgContr);
    sendBuilderbotMessage(grupoId, msgGrupo);

    Swal.fire({icon:'success',title:'Cuenta marcada como REVISADA POR SUPERVISOR',timer:1800,showConfirmButton:false});
    await cargarCuentas();
    showView('view-revision');
  }catch(e){
    Swal.fire({icon:'error',title:'Error',text:e.message});
  }
});

document.getElementById('rc-devolver').addEventListener('click', async ()=>{
  if(!REV_CUENTA) return;
  const observ = (document.getElementById('rc-observaciones').value||'').trim();
  if(!observ){
    Swal.fire({icon:'warning',title:'Observaci√≥n requerida',text:'Escribe la observaci√≥n para devolver'}); return;
  }
  try{
    const documento = REV_CUENTA.contratista.documento;
    const informe   = REV_CUENTA.cuenta.informe;
    await apiPost('devolverCuentaSupervisor', { documento, informe, observaciones: observ });

    // WhatsApp al contratista
    const nombre = REV_CUENTA.contratista.nombre;
    const supervisor = currentUser?.supervisor || '';
    const telContratista = normalizeNumber(REV_CUENTA.contratista.telefono);
    const msg =
      'Estimado(a) *'+nombre+'*\n\n' +
      'Se ha devuelto tu *Cuenta N¬∞ '+informe+'* por esta inconsistencia:\n\n*'+observ+'*\n\n' +
      'Haz la correcci√≥n desde la *App Contratista* teniendo en cuenta las observaciones anteriores.\n\n' +
      'Cordialmente,\n\n*'+supervisor+'*\n> Supervisor(a)';
    if(telContratista) sendBuilderbotMessage(telContratista, msg);

    Swal.fire({icon:'success',title:'Cuenta devuelta (se notific√≥ al contratista)',timer:1800,showConfirmButton:false});
    await cargarCuentas();
    showView('view-revision');
  }catch(e){
    Swal.fire({icon:'error',title:'Error',text:e.message});
  }
});

/* ================== REQUERIMIENTOS ================== */
let REQ_DATA=[];
async function cargarRequerimientosBase(){
  try{
    const list=await apiGet('listContratistasSupervisor', { supervisor: currentUser?.supervisor || '' });
    REQ_DATA=Array.isArray(list)?list:[];
    pintarReq(REQ_DATA);
  }catch(e){
    REQ_DATA=[]; pintarReq(REQ_DATA);
  }
}
function pintarReq(list){
  const wrap=document.getElementById('req-list'); wrap.innerHTML='';
  if(!list.length){ wrap.innerHTML='<p class="muted center">No hay contratistas.</p>'; return; }
  for(const c of list){
    const card=document.createElement('div'); card.className='item-card';
    const header=document.createElement('div'); header.className='item-header';
    const title=document.createElement('p'); title.className='item-title'; title.textContent='NOMBRE: '+(c.nombre||'');
    header.appendChild(title); card.appendChild(header);
    const btns=document.createElement('div'); btns.className='btn-row';
    const btn=document.createElement('button'); btn.textContent='REDACTAR';
    btn.addEventListener('click', ()=> abrirModalReq(c));
    btns.appendChild(btn); card.appendChild(btns);
    wrap.appendChild(card);
  }
}
document.getElementById('req-volver').addEventListener('click', ()=> showView('view-inicio'));

let MODAL_REQ_TARGET=null;
function abrirModalReq(c){
  MODAL_REQ_TARGET=c;
  document.getElementById('modal-req-text').value='';
  document.getElementById('modal-requerimiento').classList.remove('hidden');
}
document.getElementById('modal-req-cancelar').addEventListener('click', ()=>{
  document.getElementById('modal-requerimiento').classList.add('hidden');
});
document.getElementById('modal-req-enviar').addEventListener('click', ()=>{
  const txt=(document.getElementById('modal-req-text').value||'').trim();
  if(!MODAL_REQ_TARGET || !txt){ return; }
  const nombre = (MODAL_REQ_TARGET.nombre||'').trim();
  const tel = normalizeNumber(MODAL_REQ_TARGET.telefono);
  const mensaje =
    'Estimado(a) *'+nombre+'*\n\n' +
    'Tenemos el siguiente requerimiento:\n\n*'+txt+'*\n\n' +
    'Cordialmente,\n\n*'+(currentUser?.supervisor||'SUPERVISOR(A)')+'*\n> Supervisor(a)';
  if(tel) sendBuilderbotMessage(tel, mensaje);
  document.getElementById('modal-requerimiento').classList.add('hidden');
  Swal.fire({icon:'success',title:'Requerimiento enviado',timer:1800,showConfirmButton:false});
});

/* ================== COMUNICADOS / SOPORTE ================== */
document.getElementById('comunicado-enviar').addEventListener('click', async ()=>{
  const txt=(document.getElementById('comunicado-text').value||'').trim();
  if(!txt){ Swal.fire({icon:'warning',title:'Texto requerido'}); return; }
  try{
    await apiPost('guardarComunicadoSupervisor', {
      cedula: currentUser?.cedula||'',
      supervisor: currentUser?.supervisor||'',
      comunicado: txt
    });
    Swal.fire({icon:'success',title:'Comunicado enviado',timer:1800,showConfirmButton:false});
    document.getElementById('comunicado-text').value='';
    showView('view-inicio');
  }catch(e){
    Swal.fire({icon:'error',title:'Error',text:e.message});
  }
});
document.getElementById('comunicado-volver').addEventListener('click', ()=> showView('view-inicio'));

document.getElementById('soporte-enviar').addEventListener('click', async ()=>{
  const txt=(document.getElementById('soporte-text').value||'').trim();
  if(!txt){ Swal.fire({icon:'warning',title:'Texto requerido'}); return; }
  try{
    await apiPost('guardarSoporteSupervisor', {
      supervisor: currentUser?.supervisor||'',
      soporte: txt
    });
    Swal.fire({icon:'success',title:'Solicitud enviada',timer:1800,showConfirmButton:false});
    document.getElementById('soporte-text').value='';
    showView('view-inicio');
  }catch(e){
    Swal.fire({icon:'error',title:'Error',text:e.message});
  }
});
document.getElementById('soporte-volver').addEventListener('click', ()=> showView('view-inicio'));

/* ================== PWA ================== */
let deferredPrompt=null;
function isStandalone(){ return window.matchMedia('(display-mode: standalone)').matches || window.matchMedia('(display-mode: installed)').matches || (window.navigator.standalone===true); }
function isIOS(){ return /(iphone|ipad|ipod)/i.test(navigator.userAgent||''); }
function isMarkedInstalled(){ try{ return localStorage.getItem('pwaInstalledFlag@sup')==='1'; }catch(_){ return false; } }
function markInstalled(){ try{ localStorage.setItem('pwaInstalledFlag@sup','1'); }catch(_){ } }
function updateInstallButtonsVisibility(){
  const btn1=document.getElementById('btn-instalar');
  const canPrompt=!!deferredPrompt; const installed=isMarkedInstalled()||isStandalone();
  const shouldShow=!installed && (canPrompt || isIOS());
  if(btn1) btn1.style.display = shouldShow ? '' : 'none';
}
window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt=e; updateInstallButtonsVisibility(); });
window.addEventListener('appinstalled', ()=>{ markInstalled(); deferredPrompt=null; updateInstallButtonsVisibility(); });
document.getElementById('btn-instalar').addEventListener('click', async ()=>{
  if(isIOS()){
    Swal.fire({icon:'info',title:'Para Instalar en tu iPhone',html:'1) Toca Compartir (cuadro con flecha).<br>2) "Agregar a pantalla de inicio".<br>3) Confirmar "Agregar".'}); return;
  }
  if(!deferredPrompt){ Swal.fire({icon:'info',title:'Instalaci√≥n no disponible todav√≠a'}); return; }
  const dp=deferredPrompt; dp.prompt(); const choice=await dp.userChoice; deferredPrompt=null;
  if(choice.outcome==='accepted'){
    markInstalled();
    Swal.fire({icon:'success',title:'¬°App instal√°ndose!', timer: 8000, showConfirmButton:false});
  }
  updateInstallButtonsVisibility();
});
async function initPWAVista(){
  if(isStandalone() || isMarkedInstalled()){ showView('view-login'); }
  else{ showView('view-instalar'); updateInstallButtonsVisibility(); }
}
if('serviceWorker' in navigator){ window.addEventListener('load', ()=>{ navigator.serviceWorker.register('./sw.js').catch(()=>{}); }); }
window.addEventListener('load', initPWAVista);

/* ================== NAVEGACI√ìN R√ÅPIDA ================== */
document.getElementById('go-contratistas').addEventListener('click', async ()=>{ await cargarContratistas(); showView('view-contratistas'); });
document.getElementById('go-revision').addEventListener('click', async ()=>{ await cargarCuentas(); showView('view-revision'); });
document.getElementById('go-requerimientos').addEventListener('click', async ()=>{ await cargarRequerimientosBase(); showView('view-requerimientos'); });
document.getElementById('go-comunicados').addEventListener('click', ()=> showView('view-comunicados'));
document.getElementById('go-soporte').addEventListener('click', ()=> showView('view-soporte'));

/* ================== FIN ================== */
</script>
</body>
</html>
